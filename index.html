<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Macro Tracker</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }

  .app { display: flex; height: 100vh; }

  /* LEFT PANEL — Daily Tracker */
  .daily-panel {
    width: 680px; min-width: 280px; max-width: 80vw; background: #1e293b; border-right: 1px solid #334155;
    display: flex; flex-direction: column; overflow: hidden; position: relative;
  }
  .resize-handle {
    position: absolute; top: 0; right: -4px; width: 8px; height: 100%;
    cursor: col-resize; z-index: 10; background: transparent;
    transition: background 0.15s;
  }
  .resize-handle:hover, .resize-handle.active { background: #3b82f6; }
  .daily-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 20px; border-bottom: 1px solid #334155; flex-shrink: 0;
  }
  .daily-header h2 {
    font-size: 15px; text-transform: uppercase; letter-spacing: 1.2px; color: #94a3b8;
  }
  .clear-day-btn {
    padding: 4px 12px; border-radius: 6px; border: 1px solid #dc2626;
    background: transparent; color: #f87171; font-size: 11px; cursor: pointer;
    font-weight: 600; letter-spacing: 0.5px; transition: all 0.15s;
  }
  .clear-day-btn:hover { background: #dc2626; color: #fff; }
  .daily-items { flex: 1; overflow-y: auto; padding: 8px 12px; }
  .daily-item {
    background: #273548; border-radius: 8px; padding: 10px 14px; margin-bottom: 6px;
    display: flex; justify-content: space-between; align-items: center; font-size: 13px;
    border: 1px solid #334155; transition: background 0.15s;
  }
  .daily-item:hover { background: #2d3f54; }
  .daily-item .item-name { font-weight: 600; color: #f1f5f9; max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .daily-item .item-amount { color: #94a3b8; font-size: 11px; }
  .daily-item .item-macros { display: flex; gap: 8px; font-size: 11px; }
  .daily-item .item-macros span { padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .macro-cal { background: #422006; color: #fb923c; }
  .item-pct { font-size: 9px; opacity: 0.7; margin-left: 3px; }
  .macro-pro { background: #052e16; color: #4ade80; }
  .macro-carb { background: #1e1b4b; color: #a78bfa; }
  .macro-fat { background: #4c0519; color: #fb7185; }
  .daily-item .item-actions { display: flex; gap: 2px; align-items: center; flex-shrink: 0; }
  .daily-item .clone-btn, .daily-item .remove-btn {
    background: none; border: none; color: #64748b; cursor: pointer; font-size: 16px;
    padding: 0 4px; line-height: 1; transition: color 0.15s;
  }
  .daily-item .clone-btn:hover { color: #4ade80; }
  .daily-item .remove-btn:hover { color: #f87171; }

  .daily-totals {
    border-top: 1px solid #334155; padding: 14px 20px; flex-shrink: 0; background: #162032;
  }
  .daily-totals h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 10px; }
  .totals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .total-box {
    border-radius: 8px; padding: 10px 12px; text-align: center;
  }
  .total-box .total-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 2px; }
  .total-box .total-value { font-size: 22px; font-weight: 700; }
  .total-pct { font-size: 12px; font-weight: 500; opacity: 0.65; }
  .total-cal { background: #422006; }
  .total-cal .total-label { color: #fdba74; }
  .total-cal .total-value { color: #fb923c; }
  .total-pro { background: #052e16; }
  .total-pro .total-label { color: #86efac; }
  .total-pro .total-value { color: #4ade80; }
  .total-carb { background: #1e1b4b; }
  .total-carb .total-label { color: #c4b5fd; }
  .total-carb .total-value { color: #a78bfa; }
  .total-fat { background: #4c0519; }
  .total-fat .total-label { color: #fda4af; }
  .total-fat .total-value { color: #fb7185; }

  .empty-state { text-align: center; padding: 40px 20px; color: #475569; }
  .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
  .empty-state p { font-size: 13px; line-height: 1.5; }

  /* RIGHT PANEL */
  .right-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; }

  /* TOP PANE — Ingredients + Amounts */
  .top-pane {
    flex: 1; display: flex; border-bottom: 2px solid #334155; min-height: 0;
  }

  /* Ingredient List */
  .ingredient-list {
    width: 280px; min-width: 280px; border-right: 1px solid #334155;
    display: flex; flex-direction: column; overflow: hidden; background: #1e293b;
  }
  .search-box {
    padding: 12px; border-bottom: 1px solid #334155; flex-shrink: 0;
  }
  .search-box input {
    width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #475569;
    background: #0f172a; color: #e2e8f0; font-size: 13px; outline: none;
    transition: border-color 0.15s;
  }
  .search-box input:focus { border-color: #3b82f6; }
  .search-box input::placeholder { color: #64748b; }
  .cat-filter {
    margin-top: 6px; width: 100%; padding: 6px 8px; border-radius: 6px;
    border: 1px solid #475569; background: #0f172a; color: #e2e8f0;
    font-size: 12px; outline: none; cursor: pointer; transition: border-color 0.15s;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2394a3b8'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center; padding-right: 24px;
  }
  .cat-filter:focus { border-color: #3b82f6; }
  .cat-filter option { background: #1e293b; color: #e2e8f0; }
  .ingredient-scroll { flex: 1; overflow-y: auto; }
  .ingredient-btn {
    display: block; width: 100%; text-align: left; padding: 10px 16px;
    background: none; border: none; border-bottom: 1px solid #1a2536;
    color: #cbd5e1; font-size: 13px; cursor: pointer; transition: all 0.12s;
  }
  .ingredient-btn:hover { background: #273548; color: #f1f5f9; }
  .ingredient-btn.active { background: #1e3a5f; color: #60a5fa; font-weight: 600; border-left: 3px solid #3b82f6; }
  .ingredient-btn .cat-dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px;
  }

  /* Amount + Saved Customs wrapper */
  .amount-wrapper {
    flex: 1; display: flex; overflow: hidden;
  }
  /* Amount List */
  .amount-panel {
    flex: 7; display: flex; flex-direction: column; overflow: hidden;
  }
  .amount-header {
    padding: 14px 20px; border-bottom: 1px solid #334155; flex-shrink: 0; background: #1a2744;
  }
  .amount-header h3 { font-size: 14px; color: #94a3b8; }
  .amount-header .sel-name { color: #60a5fa; font-weight: 700; font-size: 16px; margin-top: 2px; }
  .amount-scroll { flex: 1; overflow-y: auto; padding: 8px 12px; }
  .amount-btn {
    display: block; width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 6px;
    background: #273548; border: 1px solid #334155; border-radius: 8px;
    color: #e2e8f0; font-size: 13px; cursor: pointer; transition: all 0.12s;
  }
  .amount-btn:hover { background: #2d4a6a; border-color: #3b82f6; }
  .amount-btn.active { background: #1e3a5f; border-color: #3b82f6; }
  .amount-btn .amt-label { font-weight: 600; }
  .amount-btn .amt-grams { color: #94a3b8; font-size: 11px; margin-left: 6px; }
  .no-selection { display: flex; align-items: center; justify-content: center; height: 100%; color: #475569; font-size: 14px; }
  .custom-grams-row {
    display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    border-bottom: 1px solid #334155; background: #162032; flex-shrink: 0;
  }
  .custom-grams-row label { font-size: 11px; color: #94a3b8; white-space: nowrap; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .custom-grams-input {
    width: 70px; padding: 6px 8px; border-radius: 6px; border: 1px solid #475569;
    background: #0f172a; color: #e2e8f0; font-size: 13px; outline: none;
    text-align: center; transition: border-color 0.15s;
  }
  .custom-grams-input:focus { border-color: #3b82f6; }
  .custom-grams-input::placeholder { color: #475569; }
  .custom-grams-preview { font-size: 11px; color: #64748b; }

  /* Saved Customs Panel */
  .saved-customs-panel {
    flex: 3; border-left: 1px solid #334155; display: flex; flex-direction: column;
    overflow: hidden; background: #1a2a1a;
  }
  .saved-customs-header {
    padding: 10px 12px; border-bottom: 1px solid #334155; flex-shrink: 0;
  }
  .saved-customs-header h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #4ade80; }
  .saved-customs-scroll { flex: 1; overflow-y: auto; padding: 4px 6px; }
  .saved-custom-btn {
    display: block; width: 100%; text-align: left; padding: 7px 10px; margin-bottom: 4px;
    background: #273a27; border: 1px solid #334d33; border-radius: 6px;
    color: #e2e8f0; font-size: 11px; cursor: pointer; transition: all 0.12s;
  }
  .saved-custom-btn:hover { background: #2d4a2d; border-color: #4ade80; }
  .saved-custom-name { font-weight: 600; color: #f1f5f9; display: block; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .saved-custom-macros { font-size: 10px; color: #94a3b8; }
  .saved-custom-macros span { margin-right: 4px; }
  .saved-custom-del {
    float: right; background: none; border: none; color: #475569; cursor: pointer;
    font-size: 13px; padding: 0 2px; line-height: 1; transition: color 0.15s;
  }
  .saved-custom-del:hover { color: #f87171; }
  .saved-customs-empty { text-align: center; padding: 20px 8px; color: #475569; font-size: 11px; line-height: 1.4; }

  /* BOTTOM PANE — Macro Preview + Save */
  .bottom-pane {
    height: 200px; min-height: 200px; background: #162032; display: flex; flex-direction: column;
    justify-content: center; align-items: center; padding: 20px;
  }
  .macro-preview { display: flex; gap: 16px; margin-bottom: 20px; }
  .macro-card {
    width: 120px; border-radius: 10px; padding: 14px; text-align: center;
  }
  .macro-card .mc-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .macro-card .mc-value { font-size: 26px; font-weight: 700; }
  .macro-card .mc-unit { font-size: 11px; color: #94a3b8; }
  .mc-cal { background: #422006; } .mc-cal .mc-label { color: #fdba74; } .mc-cal .mc-value { color: #fb923c; }
  .mc-pro { background: #052e16; } .mc-pro .mc-label { color: #86efac; } .mc-pro .mc-value { color: #4ade80; }
  .mc-carb { background: #1e1b4b; } .mc-carb .mc-label { color: #c4b5fd; } .mc-carb .mc-value { color: #a78bfa; }
  .mc-fat { background: #4c0519; } .mc-fat .mc-label { color: #fda4af; } .mc-fat .mc-value { color: #fb7185; }

  .save-btn {
    padding: 12px 48px; background: #2563eb; color: #fff; border: none; border-radius: 8px;
    font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.15s;
    letter-spacing: 0.5px;
  }
  .save-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
  .save-btn:active { transform: translateY(0); }
  .save-btn:disabled { background: #334155; color: #64748b; cursor: default; transform: none; }

  .bottom-empty { color: #475569; font-size: 14px; text-align: center; }
  .bottom-empty .hint { font-size: 12px; margin-top: 6px; }

  /* PROFILE & GOALS PANE */
  .profile-pane {
    border-bottom: 2px solid #334155; padding: 14px 20px; flex-shrink: 0; background: #1a2235;
    overflow-y: auto; max-height: 440px;
  }
  .profile-pane h3 {
    font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 10px;
  }
  .profile-row { display: flex; align-items: center; margin-bottom: 10px; gap: 8px; flex-wrap: wrap; }
  .profile-row-label {
    font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px;
    width: 70px; flex-shrink: 0; font-weight: 600;
  }
  .pill-group { display: flex; gap: 4px; flex-wrap: wrap; }
  .pill-btn {
    padding: 5px 12px; border-radius: 20px; border: 1px solid #475569;
    background: #1e293b; color: #94a3b8; font-size: 12px; cursor: pointer;
    transition: all 0.12s; white-space: nowrap;
  }
  .pill-btn:hover { border-color: #60a5fa; color: #e2e8f0; }
  .pill-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; font-weight: 600; }

  .target-display { display: flex; gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #334155; }
  .target-chip {
    flex: 1; border-radius: 8px; padding: 8px 10px; text-align: center;
  }
  .target-chip .tc-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; }
  .target-chip .tc-value { font-size: 18px; font-weight: 700; }
  .target-chip .tc-unit { font-size: 10px; color: #94a3b8; }
  .tc-cal { background: #422006; } .tc-cal .tc-label { color: #fdba74; } .tc-cal .tc-value { color: #fb923c; }
  .tc-pro { background: #052e16; } .tc-pro .tc-label { color: #86efac; } .tc-pro .tc-value { color: #4ade80; }
  .tc-carb { background: #1e1b4b; } .tc-carb .tc-label { color: #c4b5fd; } .tc-carb .tc-value { color: #a78bfa; }
  .tc-fat { background: #4c0519; } .tc-fat .tc-label { color: #fda4af; } .tc-fat .tc-value { color: #fb7185; }
  .target-note { font-size: 10px; color: #475569; text-align: center; margin-top: 8px; font-style: italic; }

  /* Mode toggle */
  .mode-toggle {
    display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
    padding-bottom: 12px; border-bottom: 1px solid #334155;
  }
  .mode-toggle label {
    font-size: 12px; color: #e2e8f0; cursor: pointer; display: flex; align-items: center; gap: 8px;
  }
  .mode-toggle input[type="checkbox"] {
    width: 16px; height: 16px; accent-color: #f59e0b; cursor: pointer;
  }
  .mode-label-std { color: #60a5fa; font-weight: 600; }
  .mode-label-lc { color: #f59e0b; font-weight: 600; }
  .lc-active { background: #1a2010 !important; }
  .lc-active h3 { color: #f59e0b !important; }

  /* Bottom tab bar */
  .bottom-tab-bar {
    display: flex; border-bottom: 2px solid #334155; flex-shrink: 0; background: #0f172a;
  }
  .bottom-tab {
    flex: 1; padding: 8px 12px; text-align: center; font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px; color: #64748b;
    background: none; border: none; cursor: pointer; transition: all 0.15s;
    border-bottom: 2px solid transparent; margin-bottom: -2px;
  }
  .bottom-tab:hover { color: #94a3b8; }
  .bottom-tab.active { color: #60a5fa; border-bottom-color: #3b82f6; }
  .bottom-tab.tab-match.active { color: #f59e0b; border-bottom-color: #f59e0b; }

  /* Meal matcher pane */
  .match-pane {
    padding: 14px 20px; flex-shrink: 0; background: #1a2235;
    overflow-y: auto; max-height: 440px;
  }
  .match-pane h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #f59e0b; margin-bottom: 10px; }
  .match-section { margin-bottom: 14px; }
  .match-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: #94a3b8; margin-bottom: 6px; font-weight: 600; }
  .match-card {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; margin-bottom: 4px; background: #273548;
    border: 1px solid #334155; border-radius: 6px; cursor: pointer; transition: all 0.12s;
  }
  .match-card:hover { background: #2d4a6a; border-color: #f59e0b; }
  .match-card-name { font-size: 12px; font-weight: 600; color: #f1f5f9; }
  .match-card-macros { display: flex; gap: 5px; font-size: 10px; }
  .match-card-macros span { padding: 1px 5px; border-radius: 3px; font-weight: 600; }
  .match-card-add {
    background: none; border: none; color: #f59e0b; cursor: pointer;
    font-size: 16px; font-weight: 700; padding: 0 4px; transition: color 0.15s;
  }
  .match-card-add:hover { color: #fbbf24; }
  .match-empty { text-align: center; padding: 20px; color: #475569; font-size: 12px; font-style: italic; }
  .lc-detail { font-size: 11px; color: #94a3b8; margin-top: 4px; }

  /* CUSTOM MACRO ENTRY — compact inline */
  .custom-entry-pane {
    border-bottom: 2px solid #334155; padding: 10px 20px; flex-shrink: 0; background: #1a2a1a;
  }
  .custom-row-header {
    font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #4ade80;
    margin-bottom: 8px; font-weight: 700;
  }
  .custom-inline {
    display: flex; gap: 6px; align-items: flex-end; flex-wrap: wrap;
  }
  .custom-field-group { display: flex; flex-direction: column; gap: 2px; }
  .custom-field-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; text-align: center; }
  .custom-input {
    padding: 6px 8px; border-radius: 6px; border: 1px solid #475569;
    background: #0f172a; color: #e2e8f0; font-size: 12px; outline: none;
    transition: border-color 0.15s; width: 64px; text-align: center;
  }
  .custom-input:focus { border-color: #4ade80; }
  .custom-input::placeholder { color: #475569; }
  .custom-input.name-input { width: 150px; text-align: left; }
  .custom-add-btn {
    padding: 6px 14px; background: #166534; color: #4ade80; border: 1px solid #22c55e;
    border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .custom-add-btn:hover { background: #15803d; color: #fff; }
  .custom-add-btn:disabled { background: #1e293b; color: #475569; border-color: #334155; cursor: default; }

  /* REMAINING MACROS */
  .daily-remaining {
    border-top: 1px solid #334155; padding: 10px 20px; flex-shrink: 0; background: #0f1a2e;
  }
  .daily-remaining h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; margin-bottom: 8px; }
  .remaining-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .remain-box { border-radius: 6px; padding: 6px 8px; text-align: center; }
  .remain-box .remain-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 1px; }
  .remain-box .remain-value { font-size: 18px; font-weight: 700; }
  .remain-pct { font-size: 12px; font-weight: 500; opacity: 0.7; }
  .remain-over { opacity: 0.5; }
  .remain-over .remain-value { text-decoration: line-through; }

  /* HISTORY VIEW */
  .history-toggle-btn {
    padding: 3px 10px; border-radius: 6px; border: 1px solid #475569;
    background: transparent; color: #94a3b8; font-size: 11px; cursor: pointer;
    font-weight: 600; letter-spacing: 0.3px; transition: all 0.15s;
  }
  .history-toggle-btn:hover { border-color: #60a5fa; color: #60a5fa; }
  .history-toggle-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; }
  .history-scroll { flex: 1; overflow-y: auto; padding: 8px 12px; }
  .history-day {
    background: #1a2744; border-radius: 8px; margin-bottom: 10px;
    border: 1px solid #334155; overflow: hidden;
  }
  .history-day-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px; cursor: pointer; transition: background 0.15s;
  }
  .history-day-header:hover { background: #1e3050; }
  .history-day-date { font-size: 13px; font-weight: 700; color: #e2e8f0; }
  .history-day-summary { display: flex; gap: 6px; font-size: 11px; }
  .history-day-summary span { padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .history-day-body { padding: 0 14px 10px; border-top: 1px solid #334155; }
  .history-day-body.collapsed { display: none; }
  .history-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 5px 0; border-bottom: 1px solid #1a2536; font-size: 12px;
  }
  .history-item:last-child { border-bottom: none; }
  .history-item-name { color: #cbd5e1; font-weight: 500; }
  .history-item-time { color: #475569; font-size: 10px; margin-left: 6px; }
  .history-item-macros { display: flex; gap: 5px; font-size: 10px; }
  .history-item-macros span { padding: 1px 5px; border-radius: 3px; font-weight: 600; }
  .history-goal-row {
    display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #334155;
  }
  .history-goal-chip {
    flex: 1; border-radius: 6px; padding: 4px 6px; text-align: center; font-size: 10px;
  }
  .history-goal-chip .hg-label { text-transform: uppercase; letter-spacing: 0.5px; font-size: 8px; }
  .history-goal-chip .hg-value { font-weight: 700; font-size: 13px; }
  .hg-over { color: #f87171 !important; }
  .hg-under { color: #4ade80 !important; }
  .hg-neutral { color: #94a3b8 !important; }
  .history-empty { text-align: center; padding: 40px 20px; color: #475569; font-size: 13px; }
  .history-footer {
    border-top: 1px solid #334155; padding: 12px 16px; flex-shrink: 0; background: #162032;
  }
  .history-footer-row { display: flex; gap: 8px; align-items: center; }
  .history-btn {
    padding: 6px 14px; border-radius: 6px; border: 1px solid #475569;
    background: #1e293b; color: #94a3b8; font-size: 11px; cursor: pointer;
    font-weight: 600; transition: all 0.15s; flex: 1; text-align: center;
  }
  .history-btn:hover { border-color: #60a5fa; color: #60a5fa; }
  .import-area {
    display: none; margin-top: 8px;
  }
  .import-area.show { display: block; }
  .import-textarea {
    width: 100%; height: 80px; padding: 8px; border-radius: 6px; border: 1px solid #475569;
    background: #0f172a; color: #e2e8f0; font-size: 11px; font-family: monospace;
    outline: none; resize: vertical;
  }
  .import-textarea:focus { border-color: #3b82f6; }
  .import-actions { display: flex; gap: 6px; margin-top: 6px; }

  .preview-label {
    font-size: 12px; color: #64748b; margin-bottom: 12px; text-align: center;
  }
  .preview-label strong { color: #e2e8f0; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #475569; }

  /* Category colors */
  :root {
    --cat-protein-color: #4ade80;
    --cat-dairy-color: #60a5fa;
    --cat-grain-color: #fbbf24;
    --cat-fruit-color: #f472b6;
    --cat-veg-color: #34d399;
    --cat-fat-color: #fb923c;
    --cat-legume-color: #a78bfa;
    --cat-nut-color: #d97706;
    --cat-condiment-color: #f87171;
    --cat-bev-color: #38bdf8;
  }
  .cat-protein { background-color: var(--cat-protein-color); }
  .cat-dairy { background-color: var(--cat-dairy-color); }
  .cat-grain { background-color: var(--cat-grain-color); }
  .cat-fruit { background-color: var(--cat-fruit-color); }
  .cat-veg { background-color: var(--cat-veg-color); }
  .cat-fat { background-color: var(--cat-fat-color); }
  .cat-legume { background-color: var(--cat-legume-color); }
  .cat-nut { background-color: var(--cat-nut-color); }
  .cat-condiment { background-color: var(--cat-condiment-color); }
  .cat-bev { background-color: var(--cat-bev-color); }
</style>
</head>
<body>
<div class="app" id="app"></div>

<script>
// ============================================================
// INGREDIENT DATABASE — 100 common ingredients with macros per gram
// calories (kcal/g), protein (g/g), carbs (g/g), fat (g/g)
// ============================================================
const ingredients = [
  // PROTEIN (15)
  { id:1,  name:"Chicken Breast", cat:"protein", per_g:{cal:1.65,pro:0.31,carb:0,fat:0.036}, amounts:[{label:"3 oz",g:85},{label:"4 oz",g:113},{label:"6 oz",g:170},{label:"8 oz",g:227},{label:"1 breast (~7oz)",g:200}] },
  { id:2,  name:"Ground Beef (85/15)", cat:"protein", per_g:{cal:2.15,pro:0.265,carb:0,fat:0.15}, amounts:[{label:"3 oz",g:85},{label:"4 oz (patty)",g:113},{label:"6 oz",g:170},{label:"8 oz",g:227}] },
  { id:3,  name:"Salmon Fillet", cat:"protein", per_g:{cal:2.08,pro:0.20,carb:0,fat:0.13}, amounts:[{label:"3 oz",g:85},{label:"4 oz",g:113},{label:"6 oz fillet",g:170},{label:"8 oz fillet",g:227}] },
  { id:4,  name:"Eggs (whole)", cat:"protein", per_g:{cal:1.55,pro:0.126,carb:0.007,fat:0.11}, amounts:[{label:"1 large",g:50},{label:"2 large",g:100},{label:"3 large",g:150},{label:"4 large",g:200}] },
  { id:5,  name:"Turkey Breast", cat:"protein", per_g:{cal:1.35,pro:0.30,carb:0,fat:0.01}, amounts:[{label:"3 oz",g:85},{label:"4 oz",g:113},{label:"6 oz",g:170}] },
  { id:6,  name:"Shrimp", cat:"protein", per_g:{cal:0.99,pro:0.24,carb:0,fat:0.003}, amounts:[{label:"3 oz",g:85},{label:"6 oz",g:170},{label:"8 large (~3oz)",g:85},{label:"1 lb peeled",g:340}] },
  { id:7,  name:"Tuna (canned)", cat:"protein", per_g:{cal:1.16,pro:0.257,carb:0,fat:0.008}, amounts:[{label:"1 can (5oz)",g:142},{label:"½ can",g:71},{label:"3 oz",g:85}] },
  { id:8,  name:"Pork Chop", cat:"protein", per_g:{cal:1.97,pro:0.259,carb:0,fat:0.097}, amounts:[{label:"4 oz",g:113},{label:"6 oz chop",g:170},{label:"8 oz",g:227}] },
  { id:9,  name:"Ground Turkey", cat:"protein", per_g:{cal:1.70,pro:0.215,carb:0,fat:0.093}, amounts:[{label:"3 oz",g:85},{label:"4 oz",g:113},{label:"6 oz",g:170},{label:"8 oz",g:227}] },
  { id:10, name:"Bacon", cat:"protein", per_g:{cal:5.41,pro:0.37,carb:0,fat:0.42}, amounts:[{label:"1 slice",g:8},{label:"2 slices",g:16},{label:"3 slices",g:24},{label:"4 slices",g:32}] },
  { id:11, name:"Egg Whites", cat:"protein", per_g:{cal:0.52,pro:0.109,carb:0.007,fat:0.002}, amounts:[{label:"1 white",g:33},{label:"2 whites",g:66},{label:"3 whites",g:99},{label:"½ cup",g:122}] },
  { id:12, name:"Tilapia", cat:"protein", per_g:{cal:1.28,pro:0.26,carb:0,fat:0.023}, amounts:[{label:"3 oz",g:85},{label:"4 oz fillet",g:113},{label:"6 oz",g:170}] },
  { id:13, name:"Steak (Sirloin)", cat:"protein", per_g:{cal:1.83,pro:0.264,carb:0,fat:0.08}, amounts:[{label:"4 oz",g:113},{label:"6 oz",g:170},{label:"8 oz",g:227},{label:"12 oz",g:340}] },
  { id:14, name:"Deli Turkey", cat:"protein", per_g:{cal:1.04,pro:0.183,carb:0.036,fat:0.016}, amounts:[{label:"2 slices",g:56},{label:"4 slices",g:112},{label:"6 slices",g:168}] },
  { id:15, name:"Tofu (firm)", cat:"protein", per_g:{cal:0.83,pro:0.087,carb:0.02,fat:0.047}, amounts:[{label:"½ block",g:126},{label:"1 block",g:252},{label:"3 oz",g:85},{label:"½ cup cubed",g:126}] },

  // DAIRY (12)
  { id:16, name:"Whole Milk", cat:"dairy", per_g:{cal:0.61,pro:0.032,carb:0.048,fat:0.033}, amounts:[{label:"1 cup",g:244},{label:"½ cup",g:122},{label:"1 tbsp",g:15},{label:"2 cups",g:488}] },
  { id:17, name:"Greek Yogurt (plain)", cat:"dairy", per_g:{cal:0.59,pro:0.10,carb:0.036,fat:0.005}, amounts:[{label:"1 cup",g:245},{label:"¾ cup",g:184},{label:"½ cup",g:123},{label:"1 container (5.3oz)",g:150}] },
  { id:18, name:"Cheddar Cheese", cat:"dairy", per_g:{cal:4.03,pro:0.249,carb:0.013,fat:0.331}, amounts:[{label:"1 oz",g:28},{label:"1 slice",g:21},{label:"¼ cup shredded",g:28},{label:"½ cup shredded",g:57}] },
  { id:19, name:"Mozzarella", cat:"dairy", per_g:{cal:2.80,pro:0.222,carb:0.022,fat:0.174}, amounts:[{label:"1 oz",g:28},{label:"¼ cup shredded",g:28},{label:"½ cup shredded",g:57},{label:"1 slice",g:28}] },
  { id:20, name:"Cottage Cheese", cat:"dairy", per_g:{cal:0.98,pro:0.112,carb:0.034,fat:0.042}, amounts:[{label:"½ cup",g:113},{label:"1 cup",g:226},{label:"¼ cup",g:57}] },
  { id:21, name:"Butter", cat:"dairy", per_g:{cal:7.17,pro:0.009,carb:0.001,fat:0.811}, amounts:[{label:"1 pat",g:5},{label:"1 tbsp",g:14},{label:"2 tbsp",g:28},{label:"¼ cup (½ stick)",g:57}] },
  { id:22, name:"Cream Cheese", cat:"dairy", per_g:{cal:3.42,pro:0.059,carb:0.046,fat:0.342}, amounts:[{label:"1 tbsp",g:14},{label:"2 tbsp",g:29},{label:"1 oz",g:28}] },
  { id:23, name:"Parmesan", cat:"dairy", per_g:{cal:4.31,pro:0.357,carb:0.032,fat:0.286}, amounts:[{label:"1 tbsp grated",g:5},{label:"2 tbsp",g:10},{label:"1 oz",g:28}] },
  { id:24, name:"Heavy Cream", cat:"dairy", per_g:{cal:3.40,pro:0.021,carb:0.028,fat:0.365}, amounts:[{label:"1 tbsp",g:15},{label:"2 tbsp",g:30},{label:"¼ cup",g:60},{label:"½ cup",g:120}] },
  { id:25, name:"2% Milk", cat:"dairy", per_g:{cal:0.50,pro:0.034,carb:0.049,fat:0.020}, amounts:[{label:"1 cup",g:244},{label:"½ cup",g:122},{label:"2 cups",g:488}] },
  { id:26, name:"Sour Cream", cat:"dairy", per_g:{cal:1.98,pro:0.024,carb:0.047,fat:0.19}, amounts:[{label:"1 tbsp",g:12},{label:"2 tbsp",g:24},{label:"¼ cup",g:58}] },
  { id:27, name:"Whey Protein Powder", cat:"dairy", per_g:{cal:3.80,pro:0.80,carb:0.10,fat:0.03}, amounts:[{label:"1 scoop (~30g)",g:30},{label:"2 scoops",g:60},{label:"½ scoop",g:15}] },

  // GRAINS & STARCHES (15)
  { id:28, name:"White Rice (cooked)", cat:"grain", per_g:{cal:1.30,pro:0.027,carb:0.282,fat:0.003}, amounts:[{label:"½ cup",g:93},{label:"1 cup",g:186},{label:"1½ cups",g:279},{label:"2 cups",g:372}] },
  { id:29, name:"Brown Rice (cooked)", cat:"grain", per_g:{cal:1.23,pro:0.027,carb:0.257,fat:0.01}, amounts:[{label:"½ cup",g:98},{label:"1 cup",g:195},{label:"1½ cups",g:293}] },
  { id:30, name:"Pasta (cooked)", cat:"grain", per_g:{cal:1.58,pro:0.058,carb:0.31,fat:0.009}, amounts:[{label:"½ cup",g:70},{label:"1 cup",g:140},{label:"2 cups",g:280}] },
  { id:31, name:"Bread (white)", cat:"grain", per_g:{cal:2.65,pro:0.09,carb:0.49,fat:0.032}, amounts:[{label:"1 slice",g:25},{label:"2 slices",g:50},{label:"3 slices",g:75}] },
  { id:32, name:"Bread (whole wheat)", cat:"grain", per_g:{cal:2.47,pro:0.13,carb:0.413,fat:0.036}, amounts:[{label:"1 slice",g:28},{label:"2 slices",g:56},{label:"3 slices",g:84}] },
  { id:33, name:"Oats (dry)", cat:"grain", per_g:{cal:3.89,pro:0.169,carb:0.661,fat:0.069}, amounts:[{label:"¼ cup",g:20},{label:"½ cup",g:40},{label:"¾ cup",g:60},{label:"1 cup",g:81}] },
  { id:34, name:"Tortilla (flour)", cat:"grain", per_g:{cal:3.12,pro:0.085,carb:0.52,fat:0.077}, amounts:[{label:"1 small (6\")",g:30},{label:"1 medium (8\")",g:45},{label:"1 large (10\")",g:64},{label:"1 burrito (12\")",g:90}] },
  { id:35, name:"Quinoa (cooked)", cat:"grain", per_g:{cal:1.20,pro:0.044,carb:0.214,fat:0.019}, amounts:[{label:"½ cup",g:93},{label:"1 cup",g:185},{label:"¼ cup",g:46}] },
  { id:36, name:"Potato", cat:"grain", per_g:{cal:0.77,pro:0.02,carb:0.173,fat:0.001}, amounts:[{label:"1 medium",g:150},{label:"1 large",g:300},{label:"½ medium",g:75},{label:"1 small",g:110}] },
  { id:37, name:"Sweet Potato", cat:"grain", per_g:{cal:0.86,pro:0.016,carb:0.202,fat:0.001}, amounts:[{label:"1 medium",g:130},{label:"1 large",g:200},{label:"½ medium",g:65},{label:"1 cup cubed",g:133}] },
  { id:38, name:"Bagel", cat:"grain", per_g:{cal:2.70,pro:0.105,carb:0.531,fat:0.013}, amounts:[{label:"1 mini",g:43},{label:"1 regular",g:85},{label:"1 large",g:130}] },
  { id:39, name:"English Muffin", cat:"grain", per_g:{cal:2.35,pro:0.082,carb:0.462,fat:0.016}, amounts:[{label:"1 muffin",g:57},{label:"½ muffin",g:29}] },
  { id:40, name:"Granola", cat:"grain", per_g:{cal:4.71,pro:0.105,carb:0.648,fat:0.196}, amounts:[{label:"¼ cup",g:30},{label:"½ cup",g:61},{label:"¾ cup",g:91},{label:"1 cup",g:122}] },
  { id:41, name:"Cornbread", cat:"grain", per_g:{cal:3.05,pro:0.063,carb:0.434,fat:0.118}, amounts:[{label:"1 piece",g:65},{label:"2 pieces",g:130}] },
  { id:42, name:"Couscous (cooked)", cat:"grain", per_g:{cal:1.12,pro:0.038,carb:0.231,fat:0.002}, amounts:[{label:"½ cup",g:79},{label:"1 cup",g:157}] },

  // FRUITS (12)
  { id:43, name:"Banana", cat:"fruit", per_g:{cal:0.89,pro:0.011,carb:0.228,fat:0.003}, amounts:[{label:"1 small",g:101},{label:"1 medium",g:118},{label:"1 large",g:136},{label:"½ banana",g:59}] },
  { id:44, name:"Apple", cat:"fruit", per_g:{cal:0.52,pro:0.003,carb:0.138,fat:0.002}, amounts:[{label:"1 small",g:149},{label:"1 medium",g:182},{label:"1 large",g:223},{label:"1 cup sliced",g:109}] },
  { id:45, name:"Blueberries", cat:"fruit", per_g:{cal:0.57,pro:0.007,carb:0.145,fat:0.003}, amounts:[{label:"½ cup",g:74},{label:"1 cup",g:148},{label:"¼ cup",g:37}] },
  { id:46, name:"Strawberries", cat:"fruit", per_g:{cal:0.32,pro:0.007,carb:0.077,fat:0.003}, amounts:[{label:"1 cup whole",g:144},{label:"½ cup sliced",g:83},{label:"5 large",g:90}] },
  { id:47, name:"Orange", cat:"fruit", per_g:{cal:0.47,pro:0.009,carb:0.118,fat:0.001}, amounts:[{label:"1 small",g:96},{label:"1 medium",g:131},{label:"1 large",g:184}] },
  { id:48, name:"Grapes", cat:"fruit", per_g:{cal:0.69,pro:0.007,carb:0.181,fat:0.002}, amounts:[{label:"½ cup",g:76},{label:"1 cup",g:151},{label:"small bunch (~20)",g:100}] },
  { id:49, name:"Avocado", cat:"fruit", per_g:{cal:1.60,pro:0.02,carb:0.085,fat:0.147}, amounts:[{label:"¼ avocado",g:50},{label:"½ avocado",g:100},{label:"1 whole",g:200},{label:"2 tbsp mashed",g:30}] },
  { id:50, name:"Mango", cat:"fruit", per_g:{cal:0.60,pro:0.008,carb:0.15,fat:0.004}, amounts:[{label:"½ cup",g:83},{label:"1 cup",g:165},{label:"1 whole",g:200}] },
  { id:51, name:"Pineapple", cat:"fruit", per_g:{cal:0.50,pro:0.005,carb:0.131,fat:0.001}, amounts:[{label:"½ cup chunks",g:78},{label:"1 cup",g:156},{label:"1 ring",g:56}] },
  { id:52, name:"Raisins", cat:"fruit", per_g:{cal:2.99,pro:0.031,carb:0.792,fat:0.005}, amounts:[{label:"1 tbsp",g:10},{label:"¼ cup",g:41},{label:"small box",g:43}] },
  { id:53, name:"Dried Cranberries", cat:"fruit", per_g:{cal:3.25,pro:0.002,carb:0.827,fat:0.014}, amounts:[{label:"2 tbsp",g:20},{label:"¼ cup",g:40},{label:"⅓ cup",g:53}] },
  { id:54, name:"Lemon Juice", cat:"fruit", per_g:{cal:0.22,pro:0.004,carb:0.066,fat:0.002}, amounts:[{label:"1 tbsp",g:15},{label:"juice of 1 lemon",g:48},{label:"¼ cup",g:61}] },

  // VEGETABLES (15)
  { id:55, name:"Broccoli", cat:"veg", per_g:{cal:0.34,pro:0.028,carb:0.066,fat:0.004}, amounts:[{label:"1 cup chopped",g:91},{label:"½ cup",g:46},{label:"1 stalk",g:150},{label:"2 cups",g:182}] },
  { id:56, name:"Spinach (raw)", cat:"veg", per_g:{cal:0.23,pro:0.029,carb:0.036,fat:0.004}, amounts:[{label:"1 cup",g:30},{label:"2 cups",g:60},{label:"3 cups (big salad)",g:90},{label:"½ cup cooked",g:90}] },
  { id:57, name:"Bell Pepper", cat:"veg", per_g:{cal:0.26,pro:0.01,carb:0.06,fat:0.002}, amounts:[{label:"½ pepper",g:60},{label:"1 medium",g:119},{label:"1 cup chopped",g:149}] },
  { id:58, name:"Onion", cat:"veg", per_g:{cal:0.40,pro:0.011,carb:0.093,fat:0.001}, amounts:[{label:"¼ cup diced",g:40},{label:"½ medium",g:55},{label:"1 medium",g:110},{label:"1 cup chopped",g:160}] },
  { id:59, name:"Tomato", cat:"veg", per_g:{cal:0.18,pro:0.009,carb:0.039,fat:0.002}, amounts:[{label:"1 small",g:91},{label:"1 medium",g:123},{label:"1 large",g:182},{label:"1 cup chopped",g:180}] },
  { id:60, name:"Carrots", cat:"veg", per_g:{cal:0.41,pro:0.009,carb:0.096,fat:0.002}, amounts:[{label:"1 medium",g:61},{label:"1 cup chopped",g:128},{label:"½ cup",g:64},{label:"10 baby carrots",g:100}] },
  { id:61, name:"Garlic", cat:"veg", per_g:{cal:1.49,pro:0.064,carb:0.331,fat:0.005}, amounts:[{label:"1 clove",g:3},{label:"2 cloves",g:6},{label:"3 cloves",g:9},{label:"1 tbsp minced",g:9}] },
  { id:62, name:"Cucumber", cat:"veg", per_g:{cal:0.15,pro:0.007,carb:0.036,fat:0.001}, amounts:[{label:"½ cup sliced",g:52},{label:"1 cup",g:104},{label:"1 medium",g:201}] },
  { id:63, name:"Mushrooms", cat:"veg", per_g:{cal:0.22,pro:0.031,carb:0.033,fat:0.003}, amounts:[{label:"½ cup sliced",g:35},{label:"1 cup",g:70},{label:"5 medium",g:84},{label:"8 oz package",g:227}] },
  { id:64, name:"Zucchini", cat:"veg", per_g:{cal:0.17,pro:0.012,carb:0.032,fat:0.003}, amounts:[{label:"1 small",g:113},{label:"1 medium",g:196},{label:"1 cup sliced",g:113}] },
  { id:65, name:"Lettuce (romaine)", cat:"veg", per_g:{cal:0.17,pro:0.012,carb:0.033,fat:0.003}, amounts:[{label:"1 cup shredded",g:47},{label:"2 cups",g:94},{label:"3 leaves",g:51}] },
  { id:66, name:"Kale", cat:"veg", per_g:{cal:0.49,pro:0.043,carb:0.089,fat:0.009}, amounts:[{label:"1 cup chopped",g:67},{label:"2 cups",g:134},{label:"1 bunch",g:190}] },
  { id:67, name:"Celery", cat:"veg", per_g:{cal:0.14,pro:0.007,carb:0.03,fat:0.002}, amounts:[{label:"1 stalk",g:40},{label:"2 stalks",g:80},{label:"1 cup chopped",g:101}] },
  { id:68, name:"Corn (canned)", cat:"veg", per_g:{cal:0.82,pro:0.025,carb:0.193,fat:0.005}, amounts:[{label:"½ cup",g:82},{label:"1 cup",g:164},{label:"1 ear",g:90}] },
  { id:69, name:"Green Beans", cat:"veg", per_g:{cal:0.31,pro:0.018,carb:0.07,fat:0.001}, amounts:[{label:"½ cup",g:63},{label:"1 cup",g:125},{label:"handful (~20 beans)",g:60}] },

  // FATS & OILS (8)
  { id:70, name:"Olive Oil", cat:"fat", per_g:{cal:8.84,pro:0,carb:0,fat:1.0}, amounts:[{label:"1 tsp",g:5},{label:"1 tbsp",g:14},{label:"2 tbsp",g:28}] },
  { id:71, name:"Coconut Oil", cat:"fat", per_g:{cal:8.62,pro:0,carb:0,fat:1.0}, amounts:[{label:"1 tsp",g:5},{label:"1 tbsp",g:14},{label:"2 tbsp",g:28}] },
  { id:72, name:"Mayonnaise", cat:"fat", per_g:{cal:6.80,pro:0.01,carb:0.01,fat:0.75}, amounts:[{label:"1 tsp",g:5},{label:"1 tbsp",g:14},{label:"2 tbsp",g:28}] },
  { id:73, name:"Ranch Dressing", cat:"fat", per_g:{cal:4.62,pro:0.01,carb:0.062,fat:0.475}, amounts:[{label:"1 tbsp",g:15},{label:"2 tbsp",g:30},{label:"¼ cup",g:60}] },
  { id:74, name:"Italian Dressing", cat:"fat", per_g:{cal:2.67,pro:0.003,carb:0.1,fat:0.247}, amounts:[{label:"1 tbsp",g:15},{label:"2 tbsp",g:30}] },
  { id:75, name:"Salsa", cat:"fat", per_g:{cal:0.36,pro:0.014,carb:0.074,fat:0.002}, amounts:[{label:"2 tbsp",g:32},{label:"¼ cup",g:65},{label:"½ cup",g:130}] },
  { id:76, name:"Guacamole", cat:"fat", per_g:{cal:1.50,pro:0.02,carb:0.08,fat:0.13}, amounts:[{label:"2 tbsp",g:32},{label:"¼ cup",g:60},{label:"½ cup",g:120}] },
  { id:77, name:"Hummus", cat:"fat", per_g:{cal:1.66,pro:0.081,carb:0.143,fat:0.097}, amounts:[{label:"2 tbsp",g:30},{label:"¼ cup",g:62},{label:"⅓ cup",g:82}] },

  // LEGUMES (7)
  { id:78, name:"Black Beans (canned)", cat:"legume", per_g:{cal:0.91,pro:0.062,carb:0.162,fat:0.004}, amounts:[{label:"½ cup",g:130},{label:"1 cup",g:260},{label:"¼ cup",g:65}] },
  { id:79, name:"Chickpeas (canned)", cat:"legume", per_g:{cal:1.19,pro:0.064,carb:0.198,fat:0.021}, amounts:[{label:"½ cup",g:120},{label:"1 cup",g:240},{label:"¼ cup",g:60}] },
  { id:80, name:"Lentils (cooked)", cat:"legume", per_g:{cal:1.16,pro:0.09,carb:0.201,fat:0.004}, amounts:[{label:"½ cup",g:99},{label:"1 cup",g:198},{label:"¼ cup",g:50}] },
  { id:81, name:"Kidney Beans", cat:"legume", per_g:{cal:1.27,pro:0.089,carb:0.225,fat:0.005}, amounts:[{label:"½ cup",g:128},{label:"1 cup",g:256}] },
  { id:82, name:"Edamame", cat:"legume", per_g:{cal:1.21,pro:0.119,carb:0.084,fat:0.052}, amounts:[{label:"½ cup shelled",g:78},{label:"1 cup shelled",g:155},{label:"1 cup in pods",g:155}] },
  { id:83, name:"Peanut Butter", cat:"legume", per_g:{cal:5.88,pro:0.252,carb:0.20,fat:0.504}, amounts:[{label:"1 tbsp",g:16},{label:"2 tbsp",g:32},{label:"1 tsp",g:5}] },
  { id:84, name:"Refried Beans", cat:"legume", per_g:{cal:0.98,pro:0.058,carb:0.152,fat:0.012}, amounts:[{label:"½ cup",g:126},{label:"1 cup",g:252},{label:"¼ cup",g:63}] },

  // NUTS & SEEDS (8)
  { id:85, name:"Almonds", cat:"nut", per_g:{cal:5.79,pro:0.212,carb:0.216,fat:0.498}, amounts:[{label:"1 oz (~23)",g:28},{label:"¼ cup",g:36},{label:"½ cup",g:72},{label:"10 almonds",g:12}] },
  { id:86, name:"Walnuts", cat:"nut", per_g:{cal:6.54,pro:0.152,carb:0.137,fat:0.654}, amounts:[{label:"1 oz (~14 halves)",g:28},{label:"¼ cup chopped",g:30},{label:"½ cup",g:59}] },
  { id:87, name:"Cashews", cat:"nut", per_g:{cal:5.53,pro:0.183,carb:0.304,fat:0.438}, amounts:[{label:"1 oz (~18)",g:28},{label:"¼ cup",g:32},{label:"½ cup",g:65}] },
  { id:88, name:"Chia Seeds", cat:"nut", per_g:{cal:4.86,pro:0.169,carb:0.422,fat:0.308}, amounts:[{label:"1 tbsp",g:12},{label:"2 tbsp",g:24},{label:"¼ cup",g:40}] },
  { id:89, name:"Flax Seeds (ground)", cat:"nut", per_g:{cal:5.34,pro:0.183,carb:0.289,fat:0.423}, amounts:[{label:"1 tbsp",g:7},{label:"2 tbsp",g:14},{label:"¼ cup",g:28}] },
  { id:90, name:"Sunflower Seeds", cat:"nut", per_g:{cal:5.84,pro:0.207,carb:0.20,fat:0.514}, amounts:[{label:"1 oz",g:28},{label:"¼ cup",g:33},{label:"2 tbsp",g:18}] },
  { id:91, name:"Pecans", cat:"nut", per_g:{cal:6.91,pro:0.092,carb:0.139,fat:0.72}, amounts:[{label:"1 oz (~19 halves)",g:28},{label:"¼ cup",g:27},{label:"½ cup",g:55}] },
  { id:92, name:"Pumpkin Seeds", cat:"nut", per_g:{cal:5.59,pro:0.302,carb:0.108,fat:0.492}, amounts:[{label:"1 oz",g:28},{label:"2 tbsp",g:18},{label:"¼ cup",g:32}] },

  // CONDIMENTS & MISC (8)
  { id:93, name:"Honey", cat:"condiment", per_g:{cal:3.04,pro:0.003,carb:0.824,fat:0}, amounts:[{label:"1 tsp",g:7},{label:"1 tbsp",g:21},{label:"2 tbsp",g:42}] },
  { id:94, name:"Maple Syrup", cat:"condiment", per_g:{cal:2.60,pro:0.001,carb:0.672,fat:0.001}, amounts:[{label:"1 tbsp",g:20},{label:"2 tbsp",g:40},{label:"¼ cup",g:80}] },
  { id:95, name:"Ketchup", cat:"condiment", per_g:{cal:1.12,pro:0.013,carb:0.276,fat:0.001}, amounts:[{label:"1 tbsp",g:17},{label:"2 tbsp",g:34},{label:"1 packet",g:10}] },
  { id:96, name:"Soy Sauce", cat:"condiment", per_g:{cal:0.53,pro:0.076,carb:0.049,fat:0.001}, amounts:[{label:"1 tsp",g:6},{label:"1 tbsp",g:18},{label:"2 tbsp",g:36}] },
  { id:97, name:"BBQ Sauce", cat:"condiment", per_g:{cal:1.72,pro:0.008,carb:0.408,fat:0.006}, amounts:[{label:"1 tbsp",g:17},{label:"2 tbsp",g:34},{label:"¼ cup",g:68}] },
  { id:98, name:"Hot Sauce", cat:"condiment", per_g:{cal:0.11,pro:0.007,carb:0.017,fat:0.004}, amounts:[{label:"1 tsp",g:5},{label:"1 tbsp",g:15},{label:"2 tbsp",g:30}] },
  { id:99, name:"Sugar (white)", cat:"condiment", per_g:{cal:3.87,pro:0,carb:1.0,fat:0}, amounts:[{label:"1 tsp",g:4},{label:"1 tbsp",g:12},{label:"¼ cup",g:50},{label:"½ cup",g:100}] },
  { id:100, name:"Dark Chocolate (70%)", cat:"condiment", per_g:{cal:5.98,pro:0.079,carb:0.459,fat:0.427}, amounts:[{label:"1 square",g:10},{label:"1 oz",g:28},{label:"2 squares",g:20}] },
  { id:101, name:"Molasses", cat:"condiment", per_g:{cal:2.90,pro:0,carb:0.747,fat:0.001}, amounts:[{label:"1 tsp",g:7},{label:"1 tbsp",g:20},{label:"2 tbsp",g:40}] },
  { id:102, name:"Green Olives", cat:"veg", per_g:{cal:1.45,pro:0.01,carb:0.037,fat:0.153}, amounts:[{label:"5 olives",g:20},{label:"10 olives",g:40},{label:"¼ cup",g:33},{label:"½ cup",g:66}] },
  { id:103, name:"Black Olives", cat:"veg", per_g:{cal:1.16,pro:0.008,carb:0.064,fat:0.108}, amounts:[{label:"5 olives",g:22},{label:"10 olives",g:44},{label:"¼ cup sliced",g:33},{label:"½ cup sliced",g:66}] },
  { id:104, name:"Corn Chips", cat:"grain", per_g:{cal:5.19,pro:0.067,carb:0.610,fat:0.274}, amounts:[{label:"1 oz (~10 chips)",g:28},{label:"small bag",g:42},{label:"2 oz",g:57},{label:"big handful",g:40}] },
  { id:105, name:"Prunes (dried plums)", cat:"fruit", per_g:{cal:2.40,pro:0.022,carb:0.637,fat:0.004}, amounts:[{label:"1 prune",g:10},{label:"3 prunes",g:30},{label:"5 prunes",g:50},{label:"¼ cup",g:44},{label:"½ cup",g:87}] },
];

const catLabels = {
  protein:"Protein", dairy:"Dairy", grain:"Grains & Starches", fruit:"Fruit",
  veg:"Vegetables", fat:"Fats & Oils", legume:"Legumes", nut:"Nuts & Seeds", condiment:"Condiments"
};

// ============================================================
// MEALS & SNACKS DATABASE for meal matcher
// ============================================================
const mealDB = [
  // ======================== SNACKS ========================
  // Light (under 150 cal)
  { name:"Beef Jerky (1 oz)", type:"snack", cal:116, pro:9, carb:3, fat:7 },
  { name:"Celery + Peanut Butter (1 tbsp)", type:"snack", cal:115, pro:4, carb:5, fat:9 },
  { name:"Cucumber + Tzatziki (¼ cup)", type:"snack", cal:80, pro:3, carb:6, fat:5 },
  { name:"Rice Cake + Almond Butter", type:"snack", cal:130, pro:3, carb:14, fat:7 },
  { name:"Edamame (½ cup shelled)", type:"snack", cal:95, pro:9, carb:7, fat:4 },
  { name:"Turkey Roll-Ups (4 slices + mustard)", type:"snack", cal:75, pro:12, carb:2, fat:2 },
  { name:"String Cheese (1 stick)", type:"snack", cal:80, pro:7, carb:1, fat:5 },
  { name:"Pickles + Olives", type:"snack", cal:45, pro:1, carb:3, fat:3 },

  // Medium (150–250 cal)
  { name:"Greek Yogurt + Berries", type:"snack", cal:180, pro:18, carb:20, fat:3 },
  { name:"Protein Shake", type:"snack", cal:160, pro:30, carb:8, fat:2 },
  { name:"Hard-Boiled Eggs (2)", type:"snack", cal:155, pro:13, carb:1, fat:11 },
  { name:"Trail Mix (¼ cup)", type:"snack", cal:175, pro:5, carb:15, fat:12 },
  { name:"Cottage Cheese + Pineapple", type:"snack", cal:180, pro:14, carb:20, fat:5 },
  { name:"Cheese & Crackers", type:"snack", cal:220, pro:8, carb:18, fat:14 },
  { name:"Hummus + Veggies", type:"snack", cal:150, pro:5, carb:16, fat:8 },
  { name:"Banana + Almonds (10)", type:"snack", cal:160, pro:4, carb:27, fat:6 },
  { name:"Dark Chocolate (2 squares) + Walnuts", type:"snack", cal:200, pro:3, carb:14, fat:15 },
  { name:"Protein Bar", type:"snack", cal:210, pro:20, carb:22, fat:8 },
  { name:"Avocado Toast (½ avocado)", type:"snack", cal:220, pro:5, carb:18, fat:15 },
  { name:"Smoothie (banana + spinach + whey)", type:"snack", cal:230, pro:26, carb:30, fat:3 },

  // Heavier (250+ cal)
  { name:"Apple + Peanut Butter (2 tbsp)", type:"snack", cal:270, pro:7, carb:30, fat:16 },
  { name:"Chips + Guacamole", type:"snack", cal:300, pro:4, carb:28, fat:20 },
  { name:"Granola + Yogurt Parfait", type:"snack", cal:320, pro:14, carb:42, fat:12 },
  { name:"PB&J Sandwich", type:"snack", cal:350, pro:12, carb:42, fat:16 },
  { name:"Cheese Quesadilla (small)", type:"snack", cal:310, pro:14, carb:26, fat:18 },
  { name:"Overnight Oats (½ cup)", type:"snack", cal:280, pro:10, carb:40, fat:9 },

  // ======================== MEALS ========================
  // Lighter meals (300–450 cal)
  { name:"Egg Omelette (3) + Toast", type:"meal", cal:380, pro:24, carb:26, fat:20 },
  { name:"Grilled Chicken Salad + Dressing", type:"meal", cal:390, pro:38, carb:14, fat:20 },
  { name:"Tuna Salad Sandwich", type:"meal", cal:400, pro:30, carb:34, fat:14 },
  { name:"Turkey Burger + Side Salad", type:"meal", cal:420, pro:32, carb:28, fat:18 },
  { name:"Shrimp + Zucchini Noodles", type:"meal", cal:310, pro:30, carb:12, fat:14 },
  { name:"Greek Chicken Bowl (no rice)", type:"meal", cal:380, pro:36, carb:16, fat:18 },
  { name:"Soup & Sandwich (turkey + broth)", type:"meal", cal:400, pro:28, carb:38, fat:12 },
  { name:"Loaded Salad (chicken, egg, cheese, ranch)", type:"meal", cal:440, pro:34, carb:10, fat:30 },

  // Standard meals (450–600 cal)
  { name:"Chicken Breast + Rice + Broccoli", type:"meal", cal:480, pro:42, carb:50, fat:8 },
  { name:"Salmon + Sweet Potato + Greens", type:"meal", cal:520, pro:36, carb:42, fat:18 },
  { name:"Chicken Stir-Fry + Rice", type:"meal", cal:470, pro:35, carb:52, fat:12 },
  { name:"Bean & Cheese Burrito", type:"meal", cal:480, pro:22, carb:55, fat:18 },
  { name:"Pasta + Meat Sauce", type:"meal", cal:550, pro:28, carb:65, fat:16 },
  { name:"Steak + Potato + Green Beans", type:"meal", cal:560, pro:44, carb:38, fat:20 },
  { name:"Pork Chop + Mashed Potatoes + Corn", type:"meal", cal:540, pro:38, carb:45, fat:22 },
  { name:"Fish Tacos (2) + Slaw", type:"meal", cal:460, pro:28, carb:40, fat:20 },
  { name:"Chicken Fajitas + Tortilla", type:"meal", cal:480, pro:34, carb:38, fat:18 },
  { name:"Teriyaki Salmon + Brown Rice", type:"meal", cal:510, pro:34, carb:52, fat:14 },
  { name:"Turkey Meatballs + Pasta", type:"meal", cal:490, pro:30, carb:55, fat:14 },
  { name:"BBQ Chicken + Coleslaw + Cornbread", type:"meal", cal:560, pro:36, carb:50, fat:20 },

  // Bigger meals (600+ cal)
  { name:"Burger + Fries (classic)", type:"meal", cal:750, pro:32, carb:65, fat:38 },
  { name:"Chicken Alfredo Pasta", type:"meal", cal:680, pro:34, carb:60, fat:32 },
  { name:"Steak Burrito Bowl + Chips", type:"meal", cal:720, pro:38, carb:70, fat:28 },
  { name:"Pizza (2 slices) + Side Salad", type:"meal", cal:620, pro:24, carb:58, fat:30 },
  { name:"Breakfast Plate (eggs, bacon, toast, hash browns)", type:"meal", cal:650, pro:28, carb:48, fat:38 },
  { name:"Spaghetti Bolognese (big bowl)", type:"meal", cal:680, pro:34, carb:72, fat:22 },
];

// Score a meal against remaining macros (lower = better fit)
function scoreMeal(meal, remaining) {
  if (remaining.cal <= 0) return 99999;
  // Penalize if meal exceeds remaining calories
  const calOver = Math.max(0, meal.cal - remaining.cal);
  const calFit = Math.abs(meal.cal - remaining.cal * 0.6); // prefer ~60% of remaining
  const proFit = Math.abs(meal.pro - (remaining.pro > 0 ? remaining.pro * 0.5 : 0));
  return calOver * 3 + calFit + proFit;
}

function getMatchedMeals(remaining, type) {
  return mealDB
    .filter(m => m.type === type && m.cal <= remaining.cal + 50)
    .map(m => ({ ...m, score: scoreMeal(m, remaining) }))
    .sort((a, b) => a.score - b.score)
;
}

// ============================================================
// APP STATE
// ============================================================
let state = {
  selectedIngredient: null,
  selectedAmount: null,
  dailyItems: [],
  searchQuery: "",
  filterCat: "",  // empty = all categories
  panelWidth: 680,
  profile: { sex: null, height: null, weight: null, age: null, goal: null, activity: null, lowCarb: false, lcDeficit: null, lcProtein: null, lcCarbs: null },
  custom: { name: '', cal: '', pro: '', carb: '', fat: '' },
  customGrams: null,
  savedCustoms: [],  // [{ name, macros: {cal,pro,carb,fat}, ts }]
  history: {},       // { "2026-02-26": { items: [...], targets: {cal,pro,carb,fat}|null } }
  viewMode: 'today',  // 'today' | 'history'
  bottomTab: 'profile' // 'profile' | 'match'
};

function todayKey() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  let h = d.getHours(), m = d.getMinutes();
  const ampm = h >= 12 ? 'pm' : 'am';
  h = h % 12 || 12;
  return h + ':' + String(m).padStart(2,'0') + ampm;
}

function archivePreviousDays() {
  const today = todayKey();
  const oldItems = state.dailyItems.filter(item => item.date && item.date !== today);
  const todayItems = state.dailyItems.filter(item => !item.date || item.date === today);

  // Group old items by date
  const byDate = {};
  oldItems.forEach(item => {
    const dk = item.date;
    if (!byDate[dk]) byDate[dk] = [];
    byDate[dk].push(item);
  });

  // Merge into history
  Object.keys(byDate).forEach(dk => {
    if (!state.history[dk]) {
      state.history[dk] = { items: byDate[dk], targets: null };
    } else {
      // append without duplicates (by timestamp)
      const existing = new Set(state.history[dk].items.map(i => i.ts));
      byDate[dk].forEach(item => {
        if (!existing.has(item.ts)) state.history[dk].items.push(item);
      });
    }
  });

  state.dailyItems = todayItems;
}

// Snapshot today's targets into history so we can show goals vs actuals later
function snapshotTargets() {
  const today = todayKey();
  const t = getActiveTargets();
  if (t && state.dailyItems.length > 0) {
    if (!state.history[today]) state.history[today] = { items: [], targets: null };
    state.history[today].targets = { cal: t.cal, pro: t.pro, carb: t.carb, fat: t.fat };
  }
}

const heightOptions = [
  {label:"5'0\"", cm:152}, {label:"5'2\"", cm:157}, {label:"5'4\"", cm:163},
  {label:"5'6\"", cm:168}, {label:"5'8\"", cm:173}, {label:"5'10\"", cm:178},
  {label:"6'0\"", cm:183}, {label:"6'2\"", cm:188}, {label:"6'4\"", cm:193}, {label:"6'6\"", cm:198},
];
const weightOptions = [100, 120, 140, 160, 180, 200, 225, 250, 275, 300];
const ageOptions = [20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80];

// ============================================================
// LOCAL STORAGE — persist state across sessions
// ============================================================
function saveState() {
  try {
    snapshotTargets();
    const toSave = { dailyItems: state.dailyItems, profile: state.profile, panelWidth: state.panelWidth, history: state.history, savedCustoms: state.savedCustoms };
    localStorage.setItem('macroTrackerState', JSON.stringify(toSave));
  } catch(e) {}
}

function loadState() {
  try {
    const saved = localStorage.getItem('macroTrackerState');
    if (!saved) return;
    const parsed = JSON.parse(saved);
    if (parsed.dailyItems) state.dailyItems = parsed.dailyItems;
    if (parsed.profile) state.profile = parsed.profile;
    if (parsed.panelWidth) state.panelWidth = parsed.panelWidth;
    if (parsed.history) state.history = parsed.history;
    if (parsed.savedCustoms) state.savedCustoms = parsed.savedCustoms;
    // Migrate old deficit keys
    const deficitMigration = { slow: 'd500', moderate: 'd750', aggressive: 'd1000' };
    if (state.profile.lcDeficit && deficitMigration[state.profile.lcDeficit]) {
      state.profile.lcDeficit = deficitMigration[state.profile.lcDeficit];
    }
    // Stamp today's date on any items missing a date
    const today = todayKey();
    state.dailyItems.forEach(item => {
      if (!item.date) item.date = today;
      if (!item.ts) item.ts = Date.now();
    });
    // Archive items from previous days
    archivePreviousDays();
  } catch(e) {}
}

loadState();

// Activity multipliers (Harris-Benedict)
const activityOptions = [
  { key: 'sedentary',  label: 'Sedentary',           mult: 1.2  },
  { key: 'light',      label: 'Lightly Active',      mult: 1.375 },
  { key: 'moderate',   label: 'Moderately Active',   mult: 1.55 },
  { key: 'very',       label: 'Very Active',         mult: 1.725 },
  { key: 'extra',      label: 'Extra Active',        mult: 1.9  },
];

const goalOptions = [
  { key: 'cut_fast',  label: 'Aggressive Cut',  offset: -500 },
  { key: 'cut_slow',  label: 'Moderate Cut',    offset: -250 },
  { key: 'maintain',  label: 'Maintain',         offset: 0    },
  { key: 'bulk_slow', label: 'Lean Bulk',        offset: 250  },
  { key: 'bulk_fast', label: 'Aggressive Bulk',  offset: 500  },
];

// Low-Carb Deficit Mode options (fine-grained for custom targeting)
const lcDeficitOptions = [
  { key: 'd250',  label: '-250',  offset: -250 },
  { key: 'd500',  label: '-500',  offset: -500 },
  { key: 'd600',  label: '-600',  offset: -600 },
  { key: 'd700',  label: '-700',  offset: -700 },
  { key: 'd750',  label: '-750',  offset: -750 },
  { key: 'd800',  label: '-800',  offset: -800 },
  { key: 'd900',  label: '-900',  offset: -900 },
  { key: 'd1000', label: '-1000', offset: -1000 },
  { key: 'd1100', label: '-1100', offset: -1100 },
  { key: 'd1150', label: '-1150', offset: -1150 },
  { key: 'd1200', label: '-1200', offset: -1200 },
  { key: 'd1250', label: '-1250', offset: -1250 },
  { key: 'd1500', label: '-1500', offset: -1500 },
];
const lcProteinOptions = [0.5, 0.6, 0.65, 0.7, 0.8, 0.9, 1.0];
const lcCarbOptions = [20, 30, 40, 50, 75, 100];

// Low-Carb Deficit calculation
function calcLowCarbTargets() {
  const p = state.profile;
  if (!p.sex || !p.height || !p.weight || !p.age || !p.activity || !p.lcDeficit || !p.lcProtein || p.lcCarbs === null) return null;

  const wKg = p.weight * 0.4536;
  const hCm = p.height;
  const age = p.age;

  // Mifflin-St Jeor BMR
  let bmr = 10 * wKg + 6.25 * hCm - 5 * age;
  bmr += p.sex === 'male' ? 5 : -161;

  const actMult = activityOptions.find(a => a.key === p.activity).mult;
  const defOff = lcDeficitOptions.find(d => d.key === p.lcDeficit).offset;
  const goalCal = Math.round(bmr * actMult + defOff);

  // Protein: user-selected g/lb
  const proGrams = Math.round(p.weight * p.lcProtein);
  // Carbs: user-selected ceiling
  const carbGrams = p.lcCarbs;
  // Fat: remainder
  const fatCal = Math.max(0, goalCal - (proGrams * 4) - (carbGrams * 4));
  const fatGrams = Math.round(fatCal / 9);

  const total = (proGrams * 4) + (carbGrams * 4) + (fatGrams * 9);
  const proPct = Math.round((proGrams * 4) / total * 100) || 0;
  const carbPct = Math.round((carbGrams * 4) / total * 100) || 0;
  const fatPct = Math.round((fatGrams * 9) / total * 100) || 0;

  return { cal: goalCal, pro: proGrams, carb: carbGrams, fat: fatGrams, proPct, carbPct, fatPct, bmr: Math.round(bmr), tdee: Math.round(bmr * actMult) };
}

// Standard Mode: Mifflin-St Jeor BMR → TDEE → goal-adjusted → protein-per-lb macro split
function calcDailyTargets() {
  const p = state.profile;
  if (!p.sex || !p.height || !p.weight || !p.age || !p.goal || !p.activity) return null;
  const wKg = p.weight * 0.4536;
  const hCm = p.height; // now actual height in cm
  const age = p.age;

  // Mifflin-St Jeor: BMR = 10m + 6.25h - 5a + s
  let bmr = 10 * wKg + 6.25 * hCm - 5 * age;
  bmr += p.sex === 'male' ? 5 : -161;

  const actMult = activityOptions.find(a => a.key === p.activity).mult;
  const goalOff = goalOptions.find(g => g.key === p.goal).offset;
  const goalCal = Math.round(bmr * actMult + goalOff);

  // Protein: 1g per lb body weight (evidence-based for body composition)
  const proGrams = Math.round(p.weight * 1.0);
  const proCal = proGrams * 4;

  // Remaining calories split ~55% carbs / ~45% fat
  const remaining = Math.max(0, goalCal - proCal);
  const carbGrams = Math.round((remaining * 0.55) / 4);
  const fatGrams = Math.round((remaining * 0.45) / 9);

  return { cal: goalCal, pro: proGrams, carb: carbGrams, fat: fatGrams };
}

function calcMacros(ingredient, grams) {
  const p = ingredient.per_g;
  return {
    cal: Math.round(p.cal * grams),
    pro: Math.round(p.pro * grams * 10) / 10,
    carb: Math.round(p.carb * grams * 10) / 10,
    fat: Math.round(p.fat * grams * 10) / 10
  };
}

function getTotals() {
  return state.dailyItems.reduce((t, item) => {
    t.cal += item.macros.cal;
    t.pro += item.macros.pro;
    t.carb += item.macros.carb;
    t.fat += item.macros.fat;
    return t;
  }, { cal: 0, pro: 0, carb: 0, fat: 0 });
}

function getActiveTargets() {
  if (state.profile.lowCarb) return calcLowCarbTargets();
  return calcDailyTargets();
}

function getFilteredIngredients() {
  let list = ingredients;
  if (state.filterCat) {
    list = list.filter(i => i.cat === state.filterCat);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    list = list.filter(i => i.name.toLowerCase().includes(q) || catLabels[i.cat].toLowerCase().includes(q));
  }
  return list;
}

// ============================================================
// HISTORY PANE RENDERER
// ============================================================
function renderHistoryPane() {
  const days = Object.keys(state.history).sort().reverse();
  let html = '';

  if (days.length === 0) {
    html += '<div class="history-empty">No history yet. Items are saved here when a new day starts or when you clear the day.</div>';
    return html;
  }

  days.forEach(function(dk) {
    const day = state.history[dk];
    const items = day.items || [];
    const targets = day.targets;

    // Compute totals for this day
    var dTotals = { cal: 0, pro: 0, carb: 0, fat: 0 };
    items.forEach(function(item) {
      dTotals.cal += item.macros.cal;
      dTotals.pro += item.macros.pro;
      dTotals.carb += item.macros.carb;
      dTotals.fat += item.macros.fat;
    });

    // Format the date nicely
    var parts = dk.split('-');
    var dateObj = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
    var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var dateLabel = dayNames[dateObj.getDay()] + ' ' + monthNames[dateObj.getMonth()] + ' ' + dateObj.getDate();

    html += '<div class="history-day">';
    html += '<div class="history-day-header" data-histday="' + dk + '">';
    html += '<span class="history-day-date">' + dateLabel + '</span>';
    html += '<div class="history-day-summary">';
    html += '<span class="macro-cal">' + Math.round(dTotals.cal) + '</span>';
    html += '<span class="macro-pro">' + Math.round(dTotals.pro) + 'p</span>';
    html += '<span class="macro-carb">' + Math.round(dTotals.carb) + 'c</span>';
    html += '<span class="macro-fat">' + Math.round(dTotals.fat) + 'f</span>';
    html += '</div></div>';

    html += '<div class="history-day-body collapsed" id="histbody-' + dk + '">';

    // Items
    items.forEach(function(item) {
      html += '<div class="history-item">';
      html += '<span><span class="history-item-name">' + item.name + '</span>';
      if (item.ts) html += '<span class="history-item-time">' + formatTime(item.ts) + '</span>';
      html += '</span>';
      html += '<div class="history-item-macros">';
      html += '<span class="macro-cal">' + item.macros.cal + '</span>';
      html += '<span class="macro-pro">' + Math.round(item.macros.pro) + 'p</span>';
      html += '<span class="macro-carb">' + Math.round(item.macros.carb) + 'c</span>';
      html += '<span class="macro-fat">' + Math.round(item.macros.fat) + 'f</span>';
      html += '</div></div>';
    });

    // Goal vs actual
    if (targets) {
      html += '<div class="history-goal-row">';
      var fields = [
        { key: 'cal', label: 'Cal', bg: '#422006', lbl: '#fdba74' },
        { key: 'pro', label: 'Pro', bg: '#052e16', lbl: '#86efac' },
        { key: 'carb', label: 'Carb', bg: '#1e1b4b', lbl: '#c4b5fd' },
        { key: 'fat', label: 'Fat', bg: '#4c0519', lbl: '#fda4af' }
      ];
      fields.forEach(function(f) {
        var actual = Math.round(dTotals[f.key]);
        var goal = targets[f.key];
        var diff = actual - goal;
        var cls = diff > 5 ? 'hg-over' : (diff < -5 ? 'hg-under' : 'hg-neutral');
        var sign = diff > 0 ? '+' : '';
        html += '<div class="history-goal-chip" style="background:' + f.bg + '">';
        html += '<div class="hg-label" style="color:' + f.lbl + '">' + f.label + '</div>';
        html += '<div class="hg-value ' + cls + '">' + sign + diff + '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div style="font-size:10px;color:#475569;text-align:center;margin-top:6px;font-style:italic;">No target data saved for this day</div>';
    }

    html += '</div>'; // history-day-body
    html += '</div>'; // history-day
  });

  return html;
}

// ============================================================
// MEAL MATCHER RENDERER
// ============================================================
function renderMatchPane() {
  var t = getActiveTargets();
  var totals = getTotals();
  if (!t) {
    return '<div class="match-pane"><div class="match-empty">Set up your profile first to get meal suggestions based on remaining macros.</div></div>';
  }

  var rem = {
    cal: t.cal - totals.cal,
    pro: t.pro - totals.pro,
    carb: t.carb - totals.carb,
    fat: t.fat - totals.fat
  };

  if (rem.cal <= 50) {
    return '<div class="match-pane"><div class="match-empty">You\'ve hit your calorie target for today! No suggestions needed.</div></div>';
  }

  var snacks = getMatchedMeals(rem, 'snack');
  var meals = getMatchedMeals(rem, 'meal');
  _lastMatchedSnacks = snacks;
  _lastMatchedMeals = meals;

  var html = '<div class="match-pane">';
  html += '<h3>Match Me a Meal</h3>';
  html += '<div style="font-size:11px;color:#94a3b8;margin-bottom:12px;">Remaining: <strong style="color:#fb923c">' + Math.round(rem.cal) + ' cal</strong>, ';
  html += '<strong style="color:#4ade80">' + Math.round(rem.pro) + 'g pro</strong>, ';
  html += '<strong style="color:#a78bfa">' + Math.round(rem.carb) + 'g carb</strong>, ';
  html += '<strong style="color:#fb7185">' + Math.round(rem.fat) + 'g fat</strong></div>';

  if (snacks.length > 0) {
    html += '<div class="match-section"><div class="match-section-title">Snacks</div>';
    snacks.forEach(function(m, i) {
      html += '<div class="match-card" data-matchadd="snack-' + i + '">';
      html += '<div><div class="match-card-name">' + m.name + '</div>';
      html += '<div class="match-card-macros">';
      html += '<span class="macro-cal">' + m.cal + '</span>';
      html += '<span class="macro-pro">' + m.pro + 'p</span>';
      html += '<span class="macro-carb">' + m.carb + 'c</span>';
      html += '<span class="macro-fat">' + m.fat + 'f</span>';
      html += '</div></div>';
      html += '<button class="match-card-add" data-matchtype="snack" data-matchidx="' + i + '">+</button>';
      html += '</div>';
    });
    html += '</div>';
  }

  if (meals.length > 0) {
    html += '<div class="match-section"><div class="match-section-title">Meals</div>';
    meals.forEach(function(m, i) {
      html += '<div class="match-card" data-matchadd="meal-' + i + '">';
      html += '<div><div class="match-card-name">' + m.name + '</div>';
      html += '<div class="match-card-macros">';
      html += '<span class="macro-cal">' + m.cal + '</span>';
      html += '<span class="macro-pro">' + m.pro + 'p</span>';
      html += '<span class="macro-carb">' + m.carb + 'c</span>';
      html += '<span class="macro-fat">' + m.fat + 'f</span>';
      html += '</div></div>';
      html += '<button class="match-card-add" data-matchtype="meal" data-matchidx="' + i + '">+</button>';
      html += '</div>';
    });
    html += '</div>';
  }

  if (snacks.length === 0 && meals.length === 0) {
    html += '<div class="match-empty">No good matches for your remaining macros. Try the custom entry above.</div>';
  }

  html += '</div>';
  return html;
}

// Store matched results for click handlers
var _lastMatchedSnacks = [];
var _lastMatchedMeals = [];

// ============================================================
// PROFILE PANE RENDERER (separate to avoid nested template literal issues)
// ============================================================
function renderProfilePane() {
  const p = state.profile;
  const isLC = p.lowCarb;

  // Shared rows
  let html = '<div class="profile-pane' + (isLC ? ' lc-active' : '') + '">';
  html += '<h3>' + (isLC ? 'Low-Carb Deficit Mode' : 'Profile & Daily Targets') + '</h3>';

  // Mode toggle
  html += '<div class="mode-toggle"><label><input type="checkbox" id="lowCarbToggle" ' + (isLC ? 'checked' : '') + ' />';
  html += '<span>Low-Carb Deficit Mode</span></label>';
  html += '<span class="' + (isLC ? 'mode-label-lc' : 'mode-label-std') + '">' + (isLC ? 'ON' : 'Standard') + '</span></div>';

  // Sex
  html += '<div class="profile-row"><span class="profile-row-label">Sex</span><div class="pill-group">';
  html += '<button class="pill-btn' + (p.sex === 'male' ? ' active' : '') + '" data-profile="sex" data-val="male">Male</button>';
  html += '<button class="pill-btn' + (p.sex === 'female' ? ' active' : '') + '" data-profile="sex" data-val="female">Female</button>';
  html += '</div></div>';

  // Height
  html += '<div class="profile-row"><span class="profile-row-label">Height</span><div class="pill-group">';
  heightOptions.forEach(function(h) {
    html += '<button class="pill-btn' + (p.height === h.cm ? ' active' : '') + '" data-profile="height" data-val="' + h.cm + '">' + h.label + '</button>';
  });
  html += '</div></div>';

  // Weight
  html += '<div class="profile-row"><span class="profile-row-label">Weight</span><div class="pill-group">';
  weightOptions.forEach(function(w) {
    html += '<button class="pill-btn' + (p.weight === w ? ' active' : '') + '" data-profile="weight" data-val="' + w + '">' + w + '</button>';
  });
  html += '</div></div>';

  // Age
  html += '<div class="profile-row"><span class="profile-row-label">Age</span><div class="pill-group">';
  ageOptions.forEach(function(a) {
    html += '<button class="pill-btn' + (p.age === a ? ' active' : '') + '" data-profile="age" data-val="' + a + '">' + a + '</button>';
  });
  html += '</div></div>';

  // Activity
  html += '<div class="profile-row"><span class="profile-row-label">Activity</span><div class="pill-group">';
  activityOptions.forEach(function(a) {
    html += '<button class="pill-btn' + (p.activity === a.key ? ' active' : '') + '" data-profile="activity" data-val="' + a.key + '">' + a.label + '</button>';
  });
  html += '</div></div>';

  if (isLC) {
    // Deficit
    html += '<div class="profile-row"><span class="profile-row-label">Deficit</span><div class="pill-group">';
    lcDeficitOptions.forEach(function(d) {
      html += '<button class="pill-btn' + (p.lcDeficit === d.key ? ' active' : '') + '" data-profile="lcDeficit" data-val="' + d.key + '">' + d.label + ' cal</button>';
    });
    html += '</div></div>';

    // Protein g/lb
    html += '<div class="profile-row"><span class="profile-row-label">Protein</span><div class="pill-group">';
    lcProteinOptions.forEach(function(v) {
      html += '<button class="pill-btn' + (p.lcProtein === v ? ' active' : '') + '" data-profile="lcProtein" data-val="' + v + '">' + v + 'g/lb</button>';
    });
    html += '</div></div>';

    // Carb cap
    html += '<div class="profile-row"><span class="profile-row-label">Carb Cap</span><div class="pill-group">';
    lcCarbOptions.forEach(function(v) {
      html += '<button class="pill-btn' + (p.lcCarbs === v ? ' active' : '') + '" data-profile="lcCarbs" data-val="' + v + '">' + v + 'g</button>';
    });
    html += '</div></div>';

    // Low-carb targets
    var t = calcLowCarbTargets();
    if (!t) {
      html += '<div class="target-note">Fill in all fields above to calculate</div>';
    } else {
      html += '<div class="target-display">';
      html += '<div class="target-chip tc-cal"><div class="tc-label">Calories</div><div class="tc-value">' + t.cal + '</div><div class="tc-unit">kcal/day</div></div>';
      html += '<div class="target-chip tc-pro"><div class="tc-label">Protein</div><div class="tc-value">' + t.pro + 'g</div><div class="tc-unit">' + t.proPct + '%</div></div>';
      html += '<div class="target-chip tc-carb"><div class="tc-label">Carbs</div><div class="tc-value">' + t.carb + 'g</div><div class="tc-unit">' + t.carbPct + '%</div></div>';
      html += '<div class="target-chip tc-fat"><div class="tc-label">Fat</div><div class="tc-value">' + t.fat + 'g</div><div class="tc-unit">' + t.fatPct + '%</div></div>';
      html += '</div>';
      var selDef = lcDeficitOptions.find(function(d) { return d.key === p.lcDeficit; });
      var defVal = selDef ? selDef.offset : 0;
      html += '<div class="lc-detail">BMR: ' + t.bmr + ' &bull; TDEE: ' + t.tdee + ' &bull; Deficit: ' + defVal + ' &bull; Target: ' + t.cal + ' kcal</div>';
      html += '<div class="target-note">Mifflin-St Jeor &bull; Protein: ' + p.lcProtein + 'g/lb &bull; Carbs capped at ' + p.lcCarbs + 'g &bull; Fat fills remainder</div>';
    }
  } else {
    // Standard: Goal row
    html += '<div class="profile-row"><span class="profile-row-label">Goal</span><div class="pill-group">';
    goalOptions.forEach(function(g) {
      html += '<button class="pill-btn' + (p.goal === g.key ? ' active' : '') + '" data-profile="goal" data-val="' + g.key + '">' + g.label + '</button>';
    });
    html += '</div></div>';

    // Standard targets
    var targets = calcDailyTargets();
    if (!targets) {
      html += '<div class="target-note">Fill in all fields to see your daily macro targets</div>';
    } else {
      html += '<div class="target-display">';
      html += '<div class="target-chip tc-cal"><div class="tc-label">Calories</div><div class="tc-value">' + targets.cal + '</div><div class="tc-unit">kcal/day</div></div>';
      html += '<div class="target-chip tc-pro"><div class="tc-label">Protein</div><div class="tc-value">' + targets.pro + 'g</div><div class="tc-unit">1g/lb</div></div>';
      html += '<div class="target-chip tc-carb"><div class="tc-label">Carbs</div><div class="tc-value">' + targets.carb + 'g</div><div class="tc-unit">55% rem</div></div>';
      html += '<div class="target-chip tc-fat"><div class="tc-label">Fat</div><div class="tc-value">' + targets.fat + 'g</div><div class="tc-unit">45% rem</div></div>';
      html += '</div>';
      html += '<div class="target-note">Mifflin-St Jeor BMR &bull; Protein: 1g/lb body weight &bull; Remaining cal: 55% carbs, 45% fat</div>';
    }
  }

  html += '</div>';
  return html;
}

// ============================================================
// RENDER
// ============================================================
function render() {
  const app = document.getElementById('app');
  // Save scroll positions before re-render
  const ingScroll = document.querySelector('.ingredient-scroll');
  const savedIngScrollTop = ingScroll ? ingScroll.scrollTop : 0;
  const dailyScroll = document.querySelector('.daily-items');
  const savedDailyScrollTop = dailyScroll ? dailyScroll.scrollTop : 0;

  const filtered = getFilteredIngredients();
  const totals = getTotals();
  const targets = getActiveTargets();
  const sel = state.selectedIngredient;
  const amt = state.selectedAmount;
  let preview = null;
  if (sel && amt) {
    preview = calcMacros(sel, amt.g);
  }

  app.innerHTML = `
    <!-- LEFT: Daily Tracker -->
    <div class="daily-panel" id="dailyPanel" style="width:${state.panelWidth}px">
      <div class="resize-handle" id="resizeHandle"></div>
      <div class="daily-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <h2>${state.viewMode === 'history' ? 'History' : 'Daily Tracker'}</h2>
          <button class="history-toggle-btn${state.viewMode === 'history' ? ' active' : ''}" id="historyToggle">
            ${state.viewMode === 'history' ? 'Back to Today' : 'History'}
          </button>
        </div>
        ${state.viewMode === 'today' && state.dailyItems.length > 0 ? '<button class="clear-day-btn" id="clearDayBtn">Clear Day</button>' : ''}
      </div>

      ${state.viewMode === 'history' ? `
      <div class="history-scroll">
        ${renderHistoryPane()}
      </div>
      <div class="history-footer">
        <div class="history-footer-row">
          <button class="history-btn" id="exportBtn">Export JSON</button>
          <button class="history-btn" id="importToggleBtn">Import JSON</button>
        </div>
        <div class="import-area" id="importArea">
          <textarea class="import-textarea" id="importTextarea" placeholder="Paste exported JSON here..."></textarea>
          <div class="import-actions">
            <button class="history-btn" id="importBtn" style="flex:none;background:#166534;color:#4ade80;border-color:#22c55e;">Import</button>
            <button class="history-btn" id="importCancelBtn" style="flex:none;">Cancel</button>
          </div>
        </div>
      </div>
      ` : `
      <div class="daily-items">
        ${state.dailyItems.length === 0 ? `
          <div class="empty-state">
            <div class="icon">&#127858;</div>
            <p>No items logged yet.<br>Select an ingredient and amount to get started.</p>
          </div>
        ` : state.dailyItems.map((item, i) => `
          <div class="daily-item">
            <div>
              <div class="item-name">${item.name}</div>
              <div class="item-amount">${item.amountLabel} (${item.grams}g)${item.ts ? ' &bull; ' + formatTime(item.ts) : ''}</div>
            </div>
            <div class="item-macros">
              <span class="macro-cal">${item.macros.cal}${targets ? `<span class="item-pct">${Math.round(item.macros.cal / targets.cal * 100)}%</span>` : ''}</span>
              <span class="macro-pro">${item.macros.pro}p</span>
              <span class="macro-carb">${item.macros.carb}c</span>
              <span class="macro-fat">${item.macros.fat}f</span>
            </div>
            <div class="item-actions">
              <button class="clone-btn" data-clone="${i}" title="Add another">+</button>
              <button class="remove-btn" data-remove="${i}">&times;</button>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="daily-totals">
        <h3>Daily Totals</h3>
        <div class="totals-grid">
          <div class="total-box total-cal">
            <div class="total-label">Calories</div>
            <div class="total-value">${totals.cal}${targets ? ` <span class="total-pct">(${Math.round(totals.cal / targets.cal * 100)}%)</span>` : ''}</div>
          </div>
          <div class="total-box total-pro">
            <div class="total-label">Protein</div>
            <div class="total-value">${Math.round(totals.pro * 10) / 10}g</div>
          </div>
          <div class="total-box total-carb">
            <div class="total-label">Carbs</div>
            <div class="total-value">${Math.round(totals.carb * 10) / 10}g</div>
          </div>
          <div class="total-box total-fat">
            <div class="total-label">Fat</div>
            <div class="total-value">${Math.round(totals.fat * 10) / 10}g</div>
          </div>
        </div>
      </div>
      ${targets ? `
      <div class="daily-remaining">
        <h3>Remaining</h3>
        <div class="remaining-grid">
          ${(() => {
            const rCal = targets.cal - totals.cal;
            const rPro = Math.round((targets.pro - totals.pro) * 10) / 10;
            const rCarb = Math.round((targets.carb - totals.carb) * 10) / 10;
            const rFat = Math.round((targets.fat - totals.fat) * 10) / 10;
            const pCal = targets.cal ? Math.round(rCal / targets.cal * 100) : 0;
            const pPro = targets.pro ? Math.round(rPro / targets.pro * 100) : 0;
            const pCarb = targets.carb ? Math.round(rCarb / targets.carb * 100) : 0;
            const pFat = targets.fat ? Math.round(rFat / targets.fat * 100) : 0;
            return `
              <div class="remain-box total-cal${rCal < 0 ? ' remain-over' : ''}">
                <div class="remain-label" style="color:#fdba74">Calories</div>
                <div class="remain-value" style="color:#fb923c">${rCal} <span class="remain-pct">(${pCal}%)</span></div>
              </div>
              <div class="remain-box total-pro${rPro < 0 ? ' remain-over' : ''}">
                <div class="remain-label" style="color:#86efac">Protein</div>
                <div class="remain-value" style="color:#4ade80">${rPro}g <span class="remain-pct">(${pPro}%)</span></div>
              </div>
              <div class="remain-box total-carb${rCarb < 0 ? ' remain-over' : ''}">
                <div class="remain-label" style="color:#c4b5fd">Carbs</div>
                <div class="remain-value" style="color:#a78bfa">${rCarb}g <span class="remain-pct">(${pCarb}%)</span></div>
              </div>
              <div class="remain-box total-fat${rFat < 0 ? ' remain-over' : ''}">
                <div class="remain-label" style="color:#fda4af">Fat</div>
                <div class="remain-value" style="color:#fb7185">${rFat}g <span class="remain-pct">(${pFat}%)</span></div>
              </div>
            `;
          })()}
        </div>
      </div>
      ` : ''}
      `}
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <!-- TOP PANE -->
      <div class="top-pane">
        <!-- Ingredient List -->
        <div class="ingredient-list">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search ingredients..." value="${state.searchQuery}" />
            <select class="cat-filter" id="catFilter" ${state.filterCat ? `style="border-color:var(--cat-${state.filterCat}-color)"` : ''}>
              <option value="">All Categories</option>
              ${Object.keys(catLabels).map(key => `
                <option value="${key}" ${state.filterCat === key ? 'selected' : ''}>● ${catLabels[key]}</option>
              `).join('')}
            </select>
          </div>
          <div class="ingredient-scroll">
            ${filtered.map(ing => `
              <button class="ingredient-btn${sel && sel.id === ing.id ? ' active' : ''}" data-id="${ing.id}">
                <span class="cat-dot cat-${ing.cat}"></span>${ing.name}
              </button>
            `).join('')}
          </div>
        </div>

        <!-- Amounts + Saved Customs -->
        <div class="amount-wrapper">
          <div class="amount-panel">
            ${sel ? `
              <div class="amount-header">
                <h3>Select Amount</h3>
                <div class="sel-name">${sel.name}</div>
              </div>
              <div class="custom-grams-row">
                <label>Custom</label>
                <input type="number" class="custom-grams-input" id="customGramsInput" placeholder="g" min="1" value="${state.customGrams || ''}" />
                <span class="custom-grams-preview" id="customGramsPreview">${state.customGrams ? (() => { const m = calcMacros(sel, state.customGrams); return m.cal + ' cal, ' + m.pro + 'p, ' + m.carb + 'c, ' + m.fat + 'f'; })() : ''}</span>
                <button class="custom-add-btn" id="customGramsUse" ${!state.customGrams ? 'disabled' : ''} style="font-size:11px;padding:4px 10px;">Use</button>
              </div>
              <div class="amount-scroll">
                ${sel.amounts.map((a, i) => `
                  <button class="amount-btn${amt && amt === a ? ' active' : ''}" data-amt="${i}">
                    <span class="amt-label">${a.label}</span>
                    <span class="amt-grams">${a.g}g</span>
                  </button>
                `).join('')}
              </div>
            ` : `<div class="no-selection">&#8592; Select an ingredient</div>`}
          </div>
          <div class="saved-customs-panel">
            <div class="saved-customs-header"><h3>Saved Customs</h3></div>
            <div class="saved-customs-scroll">
              ${state.savedCustoms.length === 0 ? `
                <div class="saved-customs-empty">Custom items you add will appear here for quick re-use.</div>
              ` : state.savedCustoms.map((sc, i) => `
                <button class="saved-custom-btn" data-savedcustom="${i}">
                  <span class="saved-custom-del" data-delsaved="${i}">&times;</span>
                  <span class="saved-custom-name">${sc.name}</span>
                  <span class="saved-custom-macros">
                    <span class="macro-cal">${sc.macros.cal}</span>
                    <span class="macro-pro">${sc.macros.pro}p</span>
                    <span class="macro-carb">${sc.macros.carb}c</span>
                    <span class="macro-fat">${sc.macros.fat}f</span>
                  </span>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM PANE — Macro Preview + Save -->
      <div class="bottom-pane">
        ${preview ? `
          <div class="preview-label">
            <strong>${sel.name}</strong> &mdash; ${amt.label} (${amt.g}g)
          </div>
          <div class="macro-preview">
            <div class="macro-card mc-cal">
              <div class="mc-label">Calories</div>
              <div class="mc-value">${preview.cal}</div>
              <div class="mc-unit">kcal</div>
            </div>
            <div class="macro-card mc-pro">
              <div class="mc-label">Protein</div>
              <div class="mc-value">${preview.pro}</div>
              <div class="mc-unit">grams</div>
            </div>
            <div class="macro-card mc-carb">
              <div class="mc-label">Carbs</div>
              <div class="mc-value">${preview.carb}</div>
              <div class="mc-unit">grams</div>
            </div>
            <div class="macro-card mc-fat">
              <div class="mc-label">Fat</div>
              <div class="mc-value">${preview.fat}</div>
              <div class="mc-unit">grams</div>
            </div>
          </div>
          <button class="save-btn" id="saveBtn">Save to Daily Tracker</button>
        ` : `
          <div class="bottom-empty">
            Select an ingredient and amount to preview macros
            <div class="hint">Macros will appear here</div>
          </div>
        `}
      </div>

      <!-- CUSTOM MACRO ENTRY — compact inline -->
      <div class="custom-entry-pane">
        <div class="custom-row-header">Quick Add Custom Item</div>
        <div class="custom-inline">
          <div class="custom-field-group">
            <span class="custom-field-label">Name</span>
            <input type="text" class="custom-input name-input" id="customName" placeholder="Item name" value="${state.custom.name}" />
          </div>
          <div class="custom-field-group">
            <span class="custom-field-label" style="color:#fb923c;">Cal</span>
            <input type="number" class="custom-input" id="customCal" placeholder="0" value="${state.custom.cal}" min="0" />
          </div>
          <div class="custom-field-group">
            <span class="custom-field-label" style="color:#4ade80;">Pro</span>
            <input type="number" class="custom-input" id="customPro" placeholder="0" value="${state.custom.pro}" min="0" />
          </div>
          <div class="custom-field-group">
            <span class="custom-field-label" style="color:#a78bfa;">Carb</span>
            <input type="number" class="custom-input" id="customCarb" placeholder="0" value="${state.custom.carb}" min="0" />
          </div>
          <div class="custom-field-group">
            <span class="custom-field-label" style="color:#fb7185;">Fat</span>
            <input type="number" class="custom-input" id="customFat" placeholder="0" value="${state.custom.fat}" min="0" />
          </div>
          <button class="custom-add-btn" id="customSaveBtn" ${!state.custom.cal ? 'disabled' : ''}>+ Add</button>
        </div>
      </div>

      <!-- TABS: Profile | Match Me -->
      <div class="bottom-tab-bar">
        <button class="bottom-tab${state.bottomTab === 'profile' ? ' active' : ''}" data-btab="profile">Profile & Goals</button>
        <button class="bottom-tab tab-match${state.bottomTab === 'match' ? ' active' : ''}" data-btab="match">Match Me</button>
      </div>
      ${state.bottomTab === 'match' ? renderMatchPane() : renderProfilePane()}
    </div>
    </div>
  `;

  // Restore scroll positions
  const newIngScroll = document.querySelector('.ingredient-scroll');
  if (newIngScroll) newIngScroll.scrollTop = savedIngScrollTop;
  const newDailyScroll = document.querySelector('.daily-items');
  if (newDailyScroll) newDailyScroll.scrollTop = savedDailyScrollTop;

  bindEvents();
  initResize();
  saveState();
}

// ============================================================
// EVENT BINDING
// ============================================================
function bindEvents() {
  // Search
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', e => {
      state.searchQuery = e.target.value;
      render();
      // refocus and restore cursor
      const inp = document.getElementById('searchInput');
      inp.focus();
      inp.setSelectionRange(inp.value.length, inp.value.length);
    });
  }

  // Category filter dropdown
  const catFilter = document.getElementById('catFilter');
  if (catFilter) {
    catFilter.addEventListener('change', e => {
      state.filterCat = e.target.value;
      render();
    });
  }

  // Ingredient buttons
  document.querySelectorAll('.ingredient-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = parseInt(btn.dataset.id);
      state.selectedIngredient = ingredients.find(i => i.id === id);
      state.selectedAmount = null;
      render();
    });
  });

  // Amount buttons
  document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.dataset.amt);
      state.selectedAmount = state.selectedIngredient.amounts[idx];
      state.customGrams = null;
      render();
    });
  });

  // Saved custom buttons — click to add to daily tracker
  document.querySelectorAll('.saved-custom-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      // Don't add if they clicked the delete button
      if (e.target.classList.contains('saved-custom-del')) return;
      const idx = parseInt(btn.dataset.savedcustom);
      const sc = state.savedCustoms[idx];
      if (!sc) return;
      state.dailyItems.push({
        name: sc.name,
        amountLabel: 'saved custom',
        grams: 0,
        macros: { ...sc.macros },
        ts: Date.now(),
        date: todayKey()
      });
      render();
    });
  });

  // Saved custom delete buttons
  document.querySelectorAll('.saved-custom-del').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const idx = parseInt(btn.dataset.delsaved);
      state.savedCustoms.splice(idx, 1);
      render();
    });
  });

  // Custom grams input — live preview without re-render
  const customGramsInput = document.getElementById('customGramsInput');
  if (customGramsInput) {
    customGramsInput.addEventListener('input', e => {
      const val = parseInt(e.target.value);
      state.customGrams = val > 0 ? val : null;
      // Update preview inline
      const prev = document.getElementById('customGramsPreview');
      const useBtn = document.getElementById('customGramsUse');
      if (prev && state.customGrams && state.selectedIngredient) {
        const m = calcMacros(state.selectedIngredient, state.customGrams);
        prev.textContent = m.cal + ' cal, ' + m.pro + 'p, ' + m.carb + 'c, ' + m.fat + 'f';
      } else if (prev) {
        prev.textContent = '';
      }
      if (useBtn) useBtn.disabled = !state.customGrams;
    });
  }

  // Custom grams "Use" button — sets as selected amount
  const customGramsUse = document.getElementById('customGramsUse');
  if (customGramsUse) {
    customGramsUse.addEventListener('click', () => {
      if (!state.customGrams || !state.selectedIngredient) return;
      state.selectedAmount = { label: state.customGrams + 'g (custom)', g: state.customGrams };
      render();
    });
  }

  // Save button
  const saveBtn = document.getElementById('saveBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      const sel = state.selectedIngredient;
      const amt = state.selectedAmount;
      if (!sel || !amt) return;
      state.dailyItems.push({
        name: sel.name,
        amountLabel: amt.label,
        grams: amt.g,
        macros: calcMacros(sel, amt.g),
        ts: Date.now(),
        date: todayKey()
      });
      state.selectedAmount = null;
      render();
    });
  }

  // Clear day button
  const clearBtn = document.getElementById('clearDayBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all items for today? They will be saved to history.')) {
        // Archive today's items to history before clearing
        const today = todayKey();
        if (state.dailyItems.length > 0) {
          if (!state.history[today]) state.history[today] = { items: [], targets: null };
          const t = getActiveTargets();
          if (t) state.history[today].targets = { cal: t.cal, pro: t.pro, carb: t.carb, fat: t.fat };
          state.dailyItems.forEach(item => {
            state.history[today].items.push(item);
          });
        }
        state.dailyItems = [];
        render();
      }
    });
  }

  // Custom macro text inputs — update state without re-rendering (to keep focus)
  const customFields = [
    { id: 'customName', key: 'name', parse: v => v },
    { id: 'customCal',  key: 'cal',  parse: v => v === '' ? '' : parseInt(v) || 0 },
    { id: 'customPro',  key: 'pro',  parse: v => v === '' ? '' : parseInt(v) || 0 },
    { id: 'customCarb', key: 'carb', parse: v => v === '' ? '' : parseInt(v) || 0 },
    { id: 'customFat',  key: 'fat',  parse: v => v === '' ? '' : parseInt(v) || 0 },
  ];
  customFields.forEach(f => {
    const el = document.getElementById(f.id);
    if (el) {
      el.addEventListener('input', e => {
        state.custom[f.key] = f.parse(e.target.value);
        // Update save button and summary without full re-render
        const btn = document.getElementById('customSaveBtn');
        if (btn) btn.disabled = !state.custom.cal;
      });
    }
  });

  // Custom save button
  const customSaveBtn = document.getElementById('customSaveBtn');
  if (customSaveBtn) {
    customSaveBtn.addEventListener('click', () => {
      if (!state.custom.cal) return;
      const label = state.custom.name.trim() || 'Custom Item';
      const macros = {
        cal: parseInt(state.custom.cal) || 0,
        pro: parseInt(state.custom.pro) || 0,
        carb: parseInt(state.custom.carb) || 0,
        fat: parseInt(state.custom.fat) || 0
      };
      state.dailyItems.push({
        name: label,
        amountLabel: 'manual',
        grams: 0,
        macros: macros,
        ts: Date.now(),
        date: todayKey()
      });
      // Save to recent customs (update if same name exists, otherwise prepend)
      const existIdx = state.savedCustoms.findIndex(s => s.name.toLowerCase() === label.toLowerCase());
      if (existIdx >= 0) {
        state.savedCustoms[existIdx] = { name: label, macros: macros, ts: Date.now() };
      } else {
        state.savedCustoms.unshift({ name: label, macros: macros, ts: Date.now() });
      }
      // Keep max 50 saved customs
      if (state.savedCustoms.length > 50) state.savedCustoms = state.savedCustoms.slice(0, 50);
      state.custom = { name: '', cal: '', pro: '', carb: '', fat: '' };
      render();
    });
  }

  // Low-carb toggle
  const lcToggle = document.getElementById('lowCarbToggle');
  if (lcToggle) {
    lcToggle.addEventListener('change', e => {
      state.profile.lowCarb = e.target.checked;
      render();
    });
  }

  // Profile pill buttons
  const numericProfileFields = ['weight', 'age', 'height', 'lcCarbs'];
  const floatProfileFields = ['lcProtein'];
  document.querySelectorAll('.pill-btn[data-profile]').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = btn.dataset.profile;
      const val = btn.dataset.val;
      if (floatProfileFields.includes(field)) {
        state.profile[field] = parseFloat(val);
      } else if (numericProfileFields.includes(field)) {
        state.profile[field] = parseInt(val);
      } else {
        state.profile[field] = val;
      }
      render();
    });
  });

  // Clone buttons
  document.querySelectorAll('.clone-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.dataset.clone);
      const orig = state.dailyItems[idx];
      if (!orig) return;
      state.dailyItems.push({
        name: orig.name,
        amountLabel: orig.amountLabel,
        grams: orig.grams,
        macros: { ...orig.macros },
        ts: Date.now(),
        date: todayKey()
      });
      render();
    });
  });

  // Remove buttons
  document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.dataset.remove);
      state.dailyItems.splice(idx, 1);
      render();
    });
  });

  // Bottom tabs (Profile / Match Me)
  document.querySelectorAll('.bottom-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      state.bottomTab = btn.dataset.btab;
      render();
    });
  });

  // Meal matcher add buttons
  document.querySelectorAll('.match-card-add').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const type = btn.dataset.matchtype;
      const idx = parseInt(btn.dataset.matchidx);
      const list = type === 'snack' ? _lastMatchedSnacks : _lastMatchedMeals;
      const m = list[idx];
      if (!m) return;
      state.dailyItems.push({
        name: m.name,
        amountLabel: 'matched ' + type,
        grams: 0,
        macros: { cal: m.cal, pro: m.pro, carb: m.carb, fat: m.fat },
        ts: Date.now(),
        date: todayKey()
      });
      render();
    });
  });

  // Also add on card click
  document.querySelectorAll('.match-card').forEach(card => {
    card.addEventListener('click', () => {
      const addBtn = card.querySelector('.match-card-add');
      if (addBtn) addBtn.click();
    });
  });

  // History toggle
  const histToggle = document.getElementById('historyToggle');
  if (histToggle) {
    histToggle.addEventListener('click', () => {
      state.viewMode = state.viewMode === 'history' ? 'today' : 'history';
      render();
    });
  }

  // History day expand/collapse
  document.querySelectorAll('.history-day-header').forEach(hdr => {
    hdr.addEventListener('click', () => {
      const dk = hdr.dataset.histday;
      const body = document.getElementById('histbody-' + dk);
      if (body) body.classList.toggle('collapsed');
    });
  });

  // Export
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      const data = {
        history: state.history,
        dailyItems: state.dailyItems,
        profile: state.profile,
        savedCustoms: state.savedCustoms,
        exportDate: new Date().toISOString()
      };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'macro-history-' + todayKey() + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // Import toggle
  const importToggleBtn = document.getElementById('importToggleBtn');
  if (importToggleBtn) {
    importToggleBtn.addEventListener('click', () => {
      const area = document.getElementById('importArea');
      if (area) area.classList.toggle('show');
    });
  }

  // Import cancel
  const importCancelBtn = document.getElementById('importCancelBtn');
  if (importCancelBtn) {
    importCancelBtn.addEventListener('click', () => {
      const area = document.getElementById('importArea');
      if (area) area.classList.remove('show');
    });
  }

  // Import execute
  const importBtn = document.getElementById('importBtn');
  if (importBtn) {
    importBtn.addEventListener('click', () => {
      const textarea = document.getElementById('importTextarea');
      if (!textarea || !textarea.value.trim()) return;
      try {
        const data = JSON.parse(textarea.value);
        if (data.history) {
          // Merge imported history with existing
          Object.keys(data.history).forEach(dk => {
            if (!state.history[dk]) {
              state.history[dk] = data.history[dk];
            } else {
              // Merge items, avoid duplicates by timestamp
              const existing = new Set(state.history[dk].items.map(i => i.ts));
              (data.history[dk].items || []).forEach(item => {
                if (!existing.has(item.ts)) state.history[dk].items.push(item);
              });
              // Keep targets if we didn't have them
              if (!state.history[dk].targets && data.history[dk].targets) {
                state.history[dk].targets = data.history[dk].targets;
              }
            }
          });
        }
        if (data.profile && !state.profile.sex && data.profile.sex) {
          state.profile = data.profile;
        }
        // Merge saved customs
        if (data.savedCustoms) {
          const existingNames = new Set(state.savedCustoms.map(s => s.name.toLowerCase()));
          data.savedCustoms.forEach(sc => {
            if (!existingNames.has(sc.name.toLowerCase())) {
              state.savedCustoms.push(sc);
              existingNames.add(sc.name.toLowerCase());
            }
          });
        }
        alert('Import successful! ' + Object.keys(data.history || {}).length + ' days imported.');
        render();
      } catch(e) {
        alert('Invalid JSON. Please paste the exported file contents.');
      }
    });
  }
}

// ============================================================
// RESIZE HANDLE — drag to resize left panel
// ============================================================
function initResize() {
  const handle = document.getElementById('resizeHandle');
  const panel = document.getElementById('dailyPanel');
  if (!handle || !panel) return;

  let startX, startWidth, dragging = false;

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    dragging = true;
    startX = e.clientX;
    startWidth = panel.offsetWidth;
    handle.classList.add('active');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const delta = e.clientX - startX;
    const newWidth = Math.max(280, Math.min(window.innerWidth * 0.8, startWidth + delta));
    panel.style.width = newWidth + 'px';
    state.panelWidth = newWidth;
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('active');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    saveState();
  });
}

// Initial render
render();
initResize();
</script>
</body>
</html>
